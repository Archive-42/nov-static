<!DOCTYPE html><html><head>
      <title>w11-d3_form-handling</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\almyk\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.5.13\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      
      <style>
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}

/* highlight */
pre[data-line] {
  position: relative;
  padding: 1em 0 1em 3em;
}
pre[data-line] .line-highlight-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  background-color: transparent;
  display: block;
  width: 100%;
}

pre[data-line] .line-highlight {
  position: absolute;
  left: 0;
  right: 0;
  padding: inherit 0;
  margin-top: 1em;
  background: hsla(24, 20%, 50%,.08);
  background: linear-gradient(to right, hsla(24, 20%, 50%,.1) 70%, hsla(24, 20%, 50%,0));
  pointer-events: none;
  line-height: inherit;
  white-space: pre;
}

pre[data-line] .line-highlight:before, 
pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-start);
  position: absolute;
  top: .4em;
  left: .6em;
  min-width: 1em;
  padding: 0 .5em;
  background-color: hsla(24, 20%, 50%,.4);
  color: hsl(24, 20%, 95%);
  font: bold 65%/1.5 sans-serif;
  text-align: center;
  vertical-align: .3em;
  border-radius: 999px;
  text-shadow: none;
  box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
  content: attr(data-end);
  top: auto;
  bottom: .4em;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h1 class="mume-header undefined" id="week-11-day-3brform-handling">WEEK-11 DAY-3<br><em>Form Handling</em></h1>

<hr>
<div class="code-chunk" data-id="code-chunk-id-0" data-cmd="toc"><div class="input-div"><div class="btn-group"><div class="run-btn btn"><span>&#x25B6;&#xFE0E;</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><ul>
<li><a href="#html-forms-learning-objectives">HTML Forms Learning Objectives</a></li>
<li><a href="#html-forms-an-introduction">HTML Forms: An Introduction</a>
<ul>
<li><a href="#key-components-of-a-form">Key components of a form</a></li>
<li><a href="#submitting-the-form">Submitting the form</a></li>
<li><a href="#what-youve-learned">What you&apos;ve learned</a></li>
</ul>
</li>
<li><a href="#html-forms-in-express">HTML Forms in Express</a>
<ul>
<li><a href="#forms-example-setup">Forms example setup</a></li>
<li><a href="#getting-the-add-guest-form">Getting the &quot;Add Guest&quot; form</a></li>
<li><a href="#a-quick-aside-pug-layout-templates">A quick aside: Pug layout templates</a></li>
<li><a href="#submitting-the-guest-form">Submitting the guest form</a></li>
<li><a href="#what-youve-learned-1">What you&apos;ve learned</a></li>
</ul>
</li>
<li><a href="#data-validation">Data Validation</a>
<ul>
<li><a href="#importance-of-server-side-data-validation">Importance of server-side data validation</a></li>
<li><a href="#server-side-validations">Server-side validations</a></li>
<li><a href="#server-side-validations-an-example">Server-side validations: an example</a></li>
<li><a href="#recap">Recap</a></li>
</ul>
</li>
<li><a href="#express-middleware">Express Middleware</a>
<ul>
<li><a href="#middleware-overview">Middleware overview</a></li>
<li><a href="#data-validations-with-middleware">Data validations with middleware</a></li>
<li><a href="#what-you-learned">What you learned</a></li>
</ul>
</li>
<li><a href="#protecting-forms-from-csrf">Protecting forms from CSRF</a>
<ul>
<li><a href="#csrf-explained">CSRF explained</a></li>
<li><a href="#preventing-csrf">Preventing CSRF</a></li>
<li><a href="#what-you-learned-1">What you learned</a></li>
</ul>
</li>
<li><a href="#formative-forms-project">Formative Forms Project</a>
<ul>
<li><a href="#getting-started">Getting started</a></li>
<li><a href="#phase-0-intro-to-the-skeleton-directory">Phase 0: Intro to the skeleton directory</a></li>
<li><a href="#phase-1-home-page">Phase 1: Home page</a></li>
<li><a href="#phase-2-create-the-normal-user-form">Phase 2: Create the normal user form</a></li>
<li><a href="#phase-3-submitting-the-form">Phase 3: Submitting the form</a></li>
<li><a href="#phase-4-create-interesting-user-form">Phase 4: Create interesting user form</a></li>
<li><a href="#phase-5-submit-create-interesting-user-form">Phase 5: Submit create interesting user form</a></li>
<li><a href="#bonus">Bonus</a></li>
</ul>
</li>
</ul>
<hr>
<hr>
<h1 class="mume-header" id="html-forms-learning-objectives">HTML Forms Learning Objectives</h1>

<p>HTML forms are the way that you collect data from a user to power your Web<br>
application. Using forms is a vital building block for your Web application<br>
knowledge. After this lesson, you should be able to:</p>
<ol>
<li>Describe the interaction between the client and server when an HTML form is<br>
loaded into the browser, the user submits it, and the server processes it</li>
<li>Create an HTML form using the Pug template engine</li>
<li>Use express to handle a form&apos;s POST request</li>
<li>Use the built-in <code>express.urlencoded()</code> middleware function to parse incoming<br>
request body form data</li>
<li>Explain what data validation is and why it&apos;s necessary for the server to<br>
validate incoming data</li>
<li>Validate user-provided data from within an Express route handler function</li>
<li>Write a custom middleware function that validates user-provided data</li>
<li>Use the <code>csurf</code> middleware to embed a token value in forms to protect against<br>
Cross-Site Request Forgery exploits</li>
</ol>
<hr>
<h1 class="mume-header" id="html-forms-an-introduction">HTML Forms: An Introduction</h1>

<p>HTML Forms are an essential and ubiquitous part of the web. You use forms to<br>
search, create resources (i.e. account, posts), update resources, and more.</p>
<p>While forms may seem simple on the surface, there&apos;s more complexity that you<br>
have to think about as a developer when you&apos;re building a web app that uses HTML<br>
forms. In this introductory lesson you will learn about:</p>
<ul>
<li>the key components of a form</li>
<li>the client and browser interaction when it comes to handling HTML forms</li>
<li>the usual flow of a form submission</li>
</ul>
<h2 class="mume-header" id="key-components-of-a-form">Key components of a form</h2>

<p>Let&apos;s imagine that a user just landed on a website you built and loads up a form<br>
that allows users to sign up for a mailing list.</p>
<p>The browser would load up HTML that includes something like this:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Sign up for an account<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/sign-up<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Name:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>fullname<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Email:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Sign Up<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</pre><p>Let&apos;s first break down the various components of the form.</p>
<h3 class="mume-header" id="form"><code>&lt;form&gt;</code></h3>

<p>The <code>&lt;form&gt;</code> element is the parent element of all of the input fields. This<br>
element has two attributes that are unique to <code>&lt;form&gt;</code> elements: <code>action</code> and<br>
<code>method</code>.</p>
<p>The <code>action</code> attribute defines the location (URL) where the form should send the<br>
data to when it is submitted. In this example, the <code>action</code> attribute has a<br>
value of <code>/sign-up</code>. The <code>action</code> can be set to either an <a href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_is_a_URL#Examples_of_absolute_URLs">absolute URL</a> or a<br>
<a href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_is_a_URL#Examples_of_relative_URLs">relative URL</a>. If it is a relative URL (ex: <code>/sign-up</code>), then it will be sent<br>
to the server that served up the website that the user is on.</p>
<p>The <code>method</code> attribute defines the HTTP verb that should be used to make the<br>
request to the server. Browsers support only two values for this attribute:<br>
&quot;get&quot; and &quot;post&quot;. You will use &quot;post&quot; 99% of the time.</p>
<blockquote>
<p>Forms typically use POST requests because POST requests are used to send data<br>
that results in a change on the server. For example, if someone wanted to sign<br>
up for an account, that form would use a POST request. In contrast, GET<br>
requests are used to retrieve data from the server. A typical use case for a<br>
form that uses a GET method is a search form. For example, the search input on<br>
<a href="http://www.google.com">www.google.com</a> is part of a form that uses a GET method.</p>
</blockquote>
<p>In this example, when the form is submitted, it will make a POST request to the<br>
server&apos;s <code>/sign-up</code> route.</p>
<h3 class="mume-header" id="input"><code>&lt;input&gt;</code></h3>

<p>In this example, there are two input fields for entering data: one for the<br>
user&apos;s name, and one for the user&apos;s email. These fields are represented by the<br>
<code>&lt;input&gt;</code> element.</p>
<p>Notice how there is a <code>type</code> attribute in each <code>&lt;input&gt;</code> element. The type<br>
attribute tells the browser what kind of input it expects, and the browser<br>
enforces different rules for each type of input.</p>
<p>For example, in the <code>&lt;input&gt;</code> field with <code>type=&quot;email&quot;</code>, if the user tries to<br>
submit an email that does not have the &quot;@&quot; character in it, then most browsers<br>
will display notify users that they have put in an invalid email address.</p>
<p>There are several types of inputs, including number, password, and checkbox. You<br>
can learn more about all of the different types types in the<br>
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input">MDN docs on input types</a>. Some of the less-commonly-used ones are quite<br>
interesting!</p>
<p>There are also other HTML elements that serve as data input fields but are not<br>
represented by an <code>&lt;input&gt;</code> element, such as <code>&lt;textarea&gt;</code> and <code>&lt;select&gt;</code>.</p>
<p>The first two <code>&lt;input&gt;</code> fields in the example also have a <code>name</code> attribute. The<br>
<code>name</code> attribute is important because when the form data is sent to the server,<br>
the data is represented in key-value pairs with the value of the <code>name</code><br>
attribute set as the key. For form submissions with a &quot;post&quot; method, the input<br>
field data would be sent to the server in the body of the HTTP request in the<br>
<code>x-www-form-urlencoded</code> format. For example, the data for the example form would<br>
look something like this when it is submitted to the server:</p>
<pre data-role="codeBlock" data-info="plaintext" class="language-plaintext"><code>fullname=John+Doe&amp;email=john@doe.com
</code></pre><p>The <code>id</code> attribute ties the <code>&lt;input&gt;</code> element to the <code>&lt;label&gt;</code> element by<br>
matching the <code>&lt;label&gt;</code> element&apos;s <code>for</code> attribute. Associating a <code>&lt;label&gt;</code><br>
element with the <code>&lt;input&gt;</code> field in this way offers accessibility and useability<br>
benefits. For example, if the user clicks on a <code>&lt;label&gt;</code> element that is<br>
associated with an <code>&lt;input&gt;</code> field, then the <code>&lt;input&gt;</code> field would come into<br>
focus.</p>
<p>Finally, the last <code>&lt;input&gt;</code> element with <code>type=&quot;submit&quot;</code> is unique in that it<br>
does not store any data. Instead, this element renders as a button with text<br>
that is equal to its <code>value</code> attribute. You could also write <code>&lt;input&gt;</code> elements<br>
with <code>type=&quot;submit&quot;</code> as a <code>&lt;button&gt;</code> element, like this:<br>
<code>&lt;button type=&quot;submit&quot;&gt;Sign Up&lt;/button&gt;</code>. When the user clicks on this button,<br>
then the form is submitted.</p>
<h2 class="mume-header" id="submitting-the-form">Submitting the form</h2>

<p>As mentioned earlier, when this form is submitted, it will make a POST request<br>
to the server&apos;s <code>/sign-up</code> route.</p>
<p>In the previous lesson, you learned about routing in an Express server, so you<br>
can imagine that the above example might make a request to a route that looks<br>
something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/sign-up&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// handle the request here</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>When the request reaches the server, the data captured in the form is then<br>
validated. For example, you might want to set up a validation that verifies that<br>
the user actually typed something into the <code>fullname</code> field before submitting.</p>
<blockquote>
<p>There are various validations that you can set on the frontend elements<br>
themselves. For example, if you add a <code>required</code> attribute to an <code>&lt;input&gt;</code><br>
field, then the browser would prevent the user from being able to submit a<br>
form if that required field were empty. <strong>However</strong>, frontend validations can<br>
be easily manipulated: someone could simply open up the dev tools and remove<br>
the <code>required</code> attribute and then submit the form with an empty input. This is<br>
why server-side validations are crucial and necessary.</p>
</blockquote>
<p>If the data is invalid, then the server would send back error messages to the<br>
frontend to be displayed to the user. For example, if the user had submitted a<br>
form with an empty <code>fullname</code> field, then the server can send back an error<br>
message to notify the user that the &quot;Name field is required&quot;. Specifically, the<br>
error would return a complete HTML page containing the entire form along with<br>
the error messages. This is so that the user can resolve the error and then<br>
resubmit the form, effectively repeating the whole form submission process<br>
again.</p>
<p>Validations can also be more robust than simple checks for whether or not a<br>
field was filled out. As a developer, you can customize and set up any sort of<br>
validation on the data that the user is submitting. In a later reading, you&apos;ll<br>
learn more about validations.</p>
<p>Finally, once the user resolves the errors, then the server can successfully<br>
process the data. At this point, the server would typically redirect the user to<br>
a different page by responding with a <code>302 Found</code> status. For example, if a user<br>
had just signed up for a new account, the server might redirect them to the<br>
profile page after they have successfully signed up.</p>
<h2 class="mume-header" id="what-youve-learned">What you&apos;ve learned</h2>

<p>In this reading, you learned about:</p>
<ul>
<li>the key components of a form</li>
<li>the client and browser interaction when it comes to handling HTML forms</li>
<li>the usual flow of a form submission</li>
</ul>
<p>In the next reading, you&apos;ll get an opportunity to build out a form that<br>
interacts with an Express server!</p>
<hr>
<h1 class="mume-header" id="html-forms-in-express">HTML Forms in Express</h1>

<p>In the previous reading, you learned about the fundamental components of an HTML<br>
form and how the client and server interacts when a form is submitted.</p>
<p>In this reading, you&apos;ll learn how to:</p>
<ul>
<li>Create an HTML form using the Pug template engine.</li>
<li>Define a pair of GET and POST routes to deliver an HTML form to the user and<br>
process requests from that form.</li>
<li>Create and use a Pug layout template to eliminate code duplication across Pug<br>
views.</li>
<li>Configure an Express application to use the built-in <code>urlencoded</code> middleware<br>
function to parse incoming request body form data (encoded as<br>
x-www-form-urlencoded).</li>
</ul>
<h2 class="mume-header" id="forms-example-setup">Forms example setup</h2>

<p>Let&apos;s learn about forms with an example. In this example, your friends are<br>
having a wedding, and they want you want to build a simple website that lets<br>
them keep track of their guest list!</p>
<p>Here&apos;s how the website will work:</p>
<ol>
<li>The website has two main pages: the home page where your friends can see the<br>
full list of guests, and a &quot;guest form&quot; page that has a form where they can<br>
add guests.</li>
<li>At the top of both pages, there should be two links that lets them easily<br>
navigate back and forth between the home page and the guest form page.</li>
<li>When they add a guest, they should be redirected back to the home page so<br>
they can see the newly added guest.</li>
</ol>
<p>Follow along by creating a <code>forms-demo</code> directory, starting up a Node project,<br>
installing the dependencies, and then creating the necessary files:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">mkdir</span> forms-demo
<span class="token function">cd</span> forms-demo
<span class="token function">npm</span> init --yes
<span class="token function">npm</span> <span class="token function">install</span> express@^4.0.0 pug@^2.0.0
<span class="token function">npm</span> <span class="token function">install</span> nodemon@^2.0.0 --save-dev
<span class="token function">mkdir</span> views
<span class="token function">touch</span> index.js views/index.pug
</pre><p>Since this example will be used and built upon in all of the remaining readings<br>
in this lesson, it&apos;s highly recommended that you actively follow along in this<br>
example. Executing the above commands should leave you with a <code>forms-demo</code><br>
directory that looks like:</p>
<pre data-role="codeBlock" data-info="plaintext" class="language-plaintext"><code>forms-demo
&#x2502;   node_modules/
|   views/
&#x2502;   &#x2502;   index.pug
&#x2502;   index.js
&#x2502;   package-lock.json
&#x2502;   package.json
</code></pre><p>Let&apos;s also set up a <code>start</code> script. Update your <code>package.json</code> so that it looks<br>
something like:</p>
<pre data-role="codeBlock" data-info="json" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;forms-demo&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;express&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;pug&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.4&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nodemon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Don&apos;t worry if the minor and patch versions of your dependencies don&apos;t end up<br>
matching exactly.</p>
<p>In your <code>index.js</code> file, set up the your Express server. In the server file,<br>
keep track of your guests with an array. When the server is first started, the<br>
guests array should be empty. Keep in mind that this guests array will be reset<br>
every time the server/application restarts. In a future lesson, you&apos;ll learn how<br>
to persist this type of data to a database in your Express applications.</p>
<p>Go ahead and also set up a root route that renders the <code>index.pug</code> template<br>
along with the <code>title</code> and <code>guests</code> array:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create the Express app.</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the pug view engine.</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pug&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> guests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Define a route.</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest List&quot;</span><span class="token punctuation">,</span> guests <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a port and start listening for connections.</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8081</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Finally, populate the <code>index.pug</code> template with some Pug content. Set the<br>
<code>title</code> in the <code>head</code> element, render an <code>h1</code> element to display the <code>title</code>,<br>
and then also set up two links to allow users to easily navigate back and forth<br>
between the <code>/</code> and <code>/guest</code> URL.</p>
<p>Underneath the navigation links, render a <code>table</code> element that will be used to<br>
keep track of all of the invited guests. There will be three pieces of<br>
information will be tracked for each guest:</p>
<ul>
<li>Full Name</li>
<li>Email</li>
<li>Guests (i.e. will they have a &quot;plus one&quot;? Can they bring their kids?)</li>
</ul>
<p>After following the instructions above, your <code>index.pug</code> should look something<br>
like this:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token doctype">doctype html</span>
<span class="token tag">html</span>
  <span class="token tag">head</span>
    <span class="token tag">title</span><span class="token punctuation">=</span><span class="token code"> title</span>
  <span class="token tag">body</span>
    <span class="token tag">h1</span><span class="token punctuation">=</span><span class="token code"> title</span>
    <span class="token tag">div</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;/&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Home</span>
    <span class="token tag">div</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Add Guest</span>

    <span class="token tag">table</span>
      <span class="token tag">thead</span>
        <span class="token tag">tr</span>
          <span class="token tag">th</span> <span class="token plain-text">Full Name</span>
          <span class="token tag">th</span> <span class="token plain-text">Email</span>
          <span class="token tag">th</span> <span class="token plain-text"># Guests</span>
      <span class="token tag">tbody</span>
        <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> guest <span class="token keyword">in</span></span> guests</span>
          <span class="token tag">tr</span>
            <span class="token tag">td</span> <span class="token plain-text">#{guest.fullname}</span>
            <span class="token tag">td</span> <span class="token plain-text">#{guest.email}</span>
            <span class="token tag">td</span> <span class="token plain-text">#{guest.numGuests}</span>
</pre><p>Alright! At this point you should be able to start up your server by running<br>
<code>npm start</code>. Navigate to <code>http://localhost:8081/</code> to see a page with an <code>h1</code><br>
element that says &quot;Guest List&quot;, two navigation links, and an empty guests table.</p>
<h2 class="mume-header" id="getting-the-add-guest-form">Getting the &quot;Add Guest&quot; form</h2>

<p>Now that you have the home page set up, let&apos;s first set up the <code>/guest</code><br>
route and view.</p>
<p>As a reminder, this view should show a very basic form that allows users to add<br>
a guest to the guest list.</p>
<p>First, create a <code>guest-form.pug</code> template for that view, and add a simple form<br>
to it with a full name input field, an email input field, a number of guests<br>
input field, and a submit input.</p>
<p>Then, add the <code>method</code> and <code>action</code> attributes to the form. Use &quot;post&quot; for the<br>
<code>method</code> attribute. For <code>action</code>, go ahead and set it so that the form<br>
submission is routed to &quot;/guest&quot;:</p>
<p>Here&apos;s what your <code>guest-form.pug</code> file should look like:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token tag">h2</span> <span class="token plain-text">Add Guest</span>
<span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span>
  <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullname&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Full Name:</span>
  <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullname&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;fullname&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;fullname&quot;</span></span><span class="token punctuation">)</span></span></span>
  <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email:</span>
  <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span>
  <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Num Guests</span>
  <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;number&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span>
  <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;Add Guest&quot;</span></span><span class="token punctuation">)</span></span></span>
</pre><blockquote>
<p><strong>Note:</strong> You&apos;ll want to be sure that the <code>name</code> of your inputs are consistent<br>
with the <code>guests</code> array object properties. The rationale for this will become<br>
clearer later in the reading when you start saving each guest into the<br>
<code>guests</code> array, but essentially, you want to keep your variable names<br>
consistent between the frontend and the backend.</p>
</blockquote>
<p>Then, set up the route in the Express server so that the <code>guest-form.pug</code><br>
template gets rendered when the user navigates to <code>localhost:8081/guest</code>. For<br>
this route, set the <code>title</code> to &quot;Guest Form&quot;:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// REST OF FILE NOT SHOWN</span>
</pre><p>Here&apos;s what the <code>index.js</code> file should look like now:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create the Express app.</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the pug view engine.</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pug&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> guests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Define a route.</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest List&quot;</span><span class="token punctuation">,</span> guests <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a port and start listening for connections.</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8081</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>When users navigate to <code>localhost:8081/guest</code>, the HTTP request will be routed<br>
to the <code>app.get(&apos;/guest&apos;)</code> route, which responds by rendering the<br>
<code>guest-form.pug</code> template. You should now see a form that allows users to input<br>
a guest&apos;s email, full name, and number of allowed guests.</p>
<h2 class="mume-header" id="a-quick-aside-pug-layout-templates">A quick aside: Pug layout templates</h2>

<p>One thing to note right now is that the <code>guest-form.pug</code> template is missing the<br>
navigation links that allows users to easily move back and forth between the<br>
home page and the guest form page.</p>
<p>To fix this, you have a couple of options. You could simply copy and paste the<br>
top of <code>index.pug</code> to the top of <code>guest-form.pug</code>. However, this solution<br>
quickly grows unwieldy once you need to add other templates that also need easy<br>
navigation.</p>
<p>Fortunately, Pug provides a clean way of preventing duplication of code with its<br>
template inheritance feature. Pug provides two keywords for template<br>
inheritance: <code>block</code> and <code>extends</code>.</p>
<p>According to the <a href="https://pugjs.org/language/inheritance.html">Pug documentation</a>, a <code>block</code> is a chunk of Pug code that &quot;a<br>
child template can replace&quot;. To understand what this means, go ahead and start a<br>
new template called <code>layout.pug</code>.</p>
<p>Then, move all of the content that you&apos;d like all of your templates to share<br>
into this <code>layout.pug</code> file. Finally, at the bottom, declare a new <code>block</code> by<br>
writing &quot;<code>block content</code>&quot;, and nest an <code>h1</code> element in that <code>block</code> that says<br>
&quot;This is the layout template.&quot; Here&apos;s what your new <code>layout.pug</code> template should<br>
look like:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token doctype">doctype html</span>
<span class="token tag">html</span>
  <span class="token tag">head</span>
    <span class="token tag">title</span><span class="token punctuation">=</span><span class="token code"> title</span>
  <span class="token tag">body</span>
    <span class="token tag">h1</span><span class="token punctuation">=</span><span class="token code"> title</span>
    <span class="token tag">div</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;/&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Home</span>
    <span class="token tag">div</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Add Guest</span>

    <span class="token keyword">block content</span>
      <span class="token tag">h1</span> <span class="token plain-text">This is the layout template</span>
</pre><p>Next, update your <code>index.pug</code> to this:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">table</span>
    <span class="token tag">thead</span>
      <span class="token tag">tr</span>
        <span class="token tag">th</span> <span class="token plain-text">Full Name</span>
        <span class="token tag">th</span> <span class="token plain-text">Email</span>
        <span class="token tag">th</span> <span class="token plain-text"># Guests</span>
    <span class="token tag">tbody</span>
      <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> guest <span class="token keyword">in</span></span> guests</span>
        <span class="token tag">tr</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.fullname}</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.email}</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.numGuests}</span>

</pre><p>Finally, update your <code>guest-form.pug</code> file to this:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">h2</span> <span class="token plain-text">Add Guest</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullname&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Full Name:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullname&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;fullname&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;fullname&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Num Guests</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;number&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;Add Guest&quot;</span></span><span class="token punctuation">)</span></span></span>

</pre><p>Then, navigate back and forth between <code>localhost:8081/</code> and<br>
<code>localhost:8081/guest</code> and see what happens.</p>
<p>Let&apos;s explore how this works. The <code>extends</code> key word denotes that the<br>
<code>index.pug</code> and <code>guest-form.pug</code> templates are now inheriting from the<br>
<code>layout.pug</code> template. This means that when the <code>index.pug</code> and <code>guest-form.pug</code><br>
templates are rendered, they will render all of the content that exists in<br>
<code>layout.pug</code>.</p>
<p>The <code>block</code> allows for any child template to redefine the content within that<br>
block. In <code>layout.pug</code>, a <code>block</code> named &quot;content&quot; is defined with an <code>h1</code><br>
element underneath it. In <code>guest-form.pug</code>, the &quot;content&quot; <code>block</code> is now<br>
redefined to render the guest <code>form</code> instead of that <code>h1</code> element.</p>
<p>This would work even if the original &quot;content&quot; <code>block</code> in <code>layout.pug</code> had no<br>
content inside of it. For example, go ahead and remove that &quot;This is the layout<br>
template&quot; <code>h1</code> from <code>layout.pug</code>, and notice how the <code>block</code> redefinition still<br>
works. You don&apos;t need to add that <code>h1</code> back to the template. That was only there<br>
to make <code>block</code> redefinitions a little bit clearer.</p>
<p>Using template inheritance, you can simply inherit from <code>layout.pug</code> in all of<br>
your new Pug templates. This is especially useful if you want to render the same<br>
navigation elements throughout your entire web application.</p>
<h2 class="mume-header" id="submitting-the-guest-form">Submitting the guest form</h2>

<p>Let&apos;s get back to finishing up the guest form.</p>
<p>Right now, if the user submits the form, it makes a POST request to &quot;/guest&quot;.<br>
Set up the route that would handle this request:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// MORE CODE TO COME</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><h3 class="mume-header" id="x-www-form-urlencoded"><code>x-www-form-urlencoded</code></h3>

<p>The previous reading briefly touched on how when forms are submitted with a<br>
&quot;post&quot; method, the data is sent to the server in the body of the HTTP request.<br>
It also mentioned how the data is encoded in a <code>x-www-form-urlencoded</code> format.<br>
Simply put, <code>x-wwww-form-urlencoded</code> format means that the data is formatted in<br>
a consistent way so that the server understands exactly what is being submitted.</p>
<p>This will make more sense with an example. When input data is sent in the body<br>
of the HTTP request, they&apos;re sent in a key-value string format, like this:<br>
<code>fullname=[FULLNAME_VALUE]&amp;email=[EMAIL_VALUE]&amp;numGuests=[NUM_GUESTS_VALUE]</code>.</p>
<p>Let&apos;s suppose you know a married couple called Jack Hill and Jill Hill. You plan<br>
on inviting them, but you really don&apos;t want to have to enter them twice. Plus,<br>
they&apos;re one of those couples that share email addresses, so it would be super<br>
convenient to enter them as one entry. So for the fullname field, you enter<br>
&quot;Jack&amp;Jill Hill&quot;. In the email field, you enter their email,<br>
<a href="mailto:%22jack.jill@hill.com">&quot;jack.jill@hill.com</a>&quot;, and then put down &quot;2&quot; for number of guests.</p>
<p>The problem here is that some characters in the key-value string format have<br>
special meaning. For example, notice how the &quot;&amp;&quot; character is used to split the<br>
two key-value pairs.</p>
<p>Unfortunately, because you put down &quot;Jack&amp;Jill Hill&quot; for the <code>fullname</code> field,<br>
it could be confusing as to whether or not the &quot;&amp;&quot; character was actually part<br>
of one of the input values or if it&apos;s there to split up a key-value pair. In<br>
order to clarify the meaning, the data string needs to be encoded so that those<br>
special characters are consistently mapped to other characters that don&apos;t have<br>
special meaning.</p>
<p>So in our example, the &quot;@&quot; character would be represented instead by &quot;%40&quot; and<br>
the &quot;&amp;&quot; symbol would be represented by &quot;%3D&quot;. This results in the data being<br>
sent in the <code>x-www-form-urlencoded</code> format that looks like this:<br>
<code>fullname=Jack%3DJill+Hill&amp;email=jack.jill%40hill.com&amp;numGuests=2</code>.</p>
<blockquote>
<p>&quot;%40&quot; and &quot;%3D&quot; are <a href="https://en.wikipedia.org/wiki/Percent-encoding">percent encoded</a> values. Values after the &quot;%&quot; character<br>
are hexadecimal values.</p>
</blockquote>
<h3 class="mume-header" id="parsing-the-request-body">Parsing the request body</h3>

<p>Once the request reaches the server, because the body of the request is now<br>
encoded in an <code>x-www-form-urlencoded</code> format, it needs to be decoded and parsed,<br>
preferably into a format that would be easy for the routes to handle.</p>
<p>Fortunately, the Express framework comes with a middleware function that does<br>
this for us. You&apos;ll learn more about middleware in an upcoming reading, but for<br>
now, go ahead and add <code>app.use(express.urlencoded())</code> to your <code>index.js</code> file<br>
under where the view engine is being set:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create the Express app.</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the pug view engine.</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pug&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> guests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Define a route.</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;layout&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest List&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// MORE CODE TO COME</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a port and start listening for connections.</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8081</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Because of the <code>express.urlencoded()</code> middleware function, the body data is now<br>
available in the <code>req</code> object. Specifically, <code>req.body</code> has now been formatted<br>
as an object that looks like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token punctuation">{</span>
  fullname<span class="token punctuation">:</span> <span class="token string">&apos;Jack&amp;Jill Hill&apos;</span><span class="token punctuation">,</span>
  email<span class="token punctuation">:</span> <span class="token string">&apos;jack.jill@hill.com&apos;</span><span class="token punctuation">,</span>
  numGuests<span class="token punctuation">:</span> <span class="token string">&apos;2&apos;</span>
<span class="token punctuation">}</span>
</pre><blockquote>
<p>Notice how the number of guests field is a string even though the <code>input</code> type<br>
was a &quot;number&quot;. This will be discussed in more detail in the next reading.</p>
</blockquote>
<p>Let&apos;s parse out the fields from the <code>req.body</code> object and push this guest entry<br>
into the <code>guests</code> array. Then, redirect the user back to the home page by using<br>
the <code>res</code> object&apos;s <code>redirect</code> method. That method redirects the user by sending<br>
a response with a <code>302 Found</code> HTTP status code to the client.</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guest <span class="token operator">=</span> <span class="token punctuation">{</span>
    fullname<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
    numGuests<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>numGuests
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  guests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>To recap, when the user submits the add guest form, the following happens:</p>
<ol>
<li>Because the <code>&lt;form&gt;</code> has a &quot;post&quot; <code>method</code>, the form data is sent in the body<br>
of the HTTP request in an <code>x-www-form-urlencoded</code> format.</li>
<li>When the request reaches the server, the <code>express.urlencoded</code> middleware<br>
function parses the urlencoded body into an object available via the<br>
<code>req.body</code> property.</li>
<li>The request is handled by the <code>/guest</code> POST route.</li>
<li>After the guest is added to the <code>guests</code> array, the server redirects the user<br>
back to the home page by sending a <code>302 Found</code> response. (Feel free confirm<br>
this in the <code>network</code> tab of your developer tools.)</li>
<li>When users lands on the home page, they can see the newly added guest in the<br>
guests table.</li>
</ol>
<h2 class="mume-header" id="what-youve-learned-1">What you&apos;ve learned</h2>

<p>There were a lot of steps that went into submitting just one simple form, but<br>
this form submission process is a common flow that you&apos;ll encounter often as a<br>
developer!</p>
<p>In this reading, you learned how to:</p>
<ul>
<li>Create an HTML form using the Pug template engine.</li>
<li>Define a pair of GET and POST routes to deliver an HTML form to the user and<br>
process requests from that form.</li>
<li>Create and use a Pug layout template to eliminate code duplication across Pug<br>
views.</li>
<li>Configure an Express application to use the built-in <code>urlencoded</code> middleware<br>
function to parse incoming request body form data (encoded as<br>
x-www-form-urlencoded).</li>
</ul>
<hr>
<h1 class="mume-header" id="data-validation">Data Validation</h1>

<p>When setting up HTML forms, it&apos;s important to check and clean the incoming data<br>
to ensure that the data is correct.</p>
<p>In this lesson, you will:</p>
<ol>
<li>Understand what data validation is and why it&apos;s necessary for the server to<br>
validate incoming data.</li>
<li>Validate user-provided data from within an Express route handler function and<br>
return a response containing user-friendly validation error messages when<br>
necessary.</li>
</ol>
<h2 class="mume-header" id="importance-of-server-side-data-validation">Importance of server-side data validation</h2>

<p>Data validation is the process of ensuring that the incoming data is correct.<br>
This section will cover the rationale for validating incoming<br>
data on the server side.</p>
<p>Even though you could add add validations on the client side, client-side<br>
validations are not as secure and can be circumvented. Because client-side<br>
validations can be circumvented, it&apos;s necessary to implement server-side data<br>
validations.</p>
<h3 class="mume-header" id="lack-of-trust-in-client-side-validations">Lack of trust in client-side validations</h3>

<p>Let&apos;s talk through an example. Suppose you had an HTML form that collects a<br>
user&apos;s age. First of all, the whole point of the form is to collect the user&apos;s<br>
age, so you want to ensure that the &quot;age&quot; field is not blank. To account for<br>
this, you set a <code>required</code> attribute on the age <code>&lt;input&gt;</code>.</p>
<p>You also want to make sure that users submit a number for their age, so you set<br>
the <code>&lt;input&gt;</code> field&apos;s <code>type</code> attribute equal to &quot;number&quot;:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>for</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/age<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Age: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">required</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</pre><p>Excellent, now, whenever users fill out this form, they&apos;re unable to submit the<br>
form unless the &quot;age&quot; field is filled out with a number. This seems like it<br>
would ensure that you have clean and correct data being submitted to your<br>
server.</p>
<p>Unfortunately, those frontend validations are not reliable. Someone could open<br>
up the developer&apos;s console and remove the <code>required</code> attribute, and then change<br>
the <code>type</code> to equal &quot;text&quot;.</p>
<p>Another situation to account for is that the end user might not even be using<br>
that specific form to submit data. Someone could be programmatically submitting<br>
a POST request to the server. In this scenario, they would never interact with<br>
the HTML form and its validations.</p>
<p>Ultimately, client-side validations are good for immediate feedback to the user,<br>
but they should not be relied upon for enforcing clean data submission.</p>
<h2 class="mume-header" id="server-side-validations">Server-side validations</h2>

<p>So what kind of data validations should you implement on the server side? Let&apos;s<br>
walk through a few examples.</p>
<h3 class="mume-header" id="expected-data-types">Expected data types</h3>

<p>The previous reading discussed how when a form is submitted, the data is<br>
typically urlencoded. One effect of this url encoding is that each value will<br>
arrive at the server as a string. Because of this, there&apos;s a tremendous need to<br>
validate that the provided string can be successfully converted to the desired<br>
type.</p>
<p>The previous example about the &quot;age&quot; field discussed how a user could circumvent<br>
the <code>type=&quot;number&quot;</code> attribute on the frontend. Without server-side data<br>
validation on that &quot;age&quot; field, you could end up with an invalid value (for<br>
example, <code>NaN</code>) when trying to convert the &quot;age&quot; value into a number in the<br>
server.</p>
<p>Other examples of data type validations include:</p>
<ul>
<li>Checking for integer vs. float<br>
(perhaps you want to only store the user&apos;s age as an integer)</li>
<li>Checking that an input date string can be converted to a valid date.</li>
</ul>
<h3 class="mume-header" id="valid-ranges-and-format">Valid ranges and format</h3>

<p>To continue with our &quot;age&quot; field example, one logical validation you might want<br>
to enforce is that users submit a valid age. For example, it&apos;s unlikely that a<br>
user is over 120 years old.</p>
<p>You could also check that values come in the correct format. A telephone number<br>
should not have any letters in it, and if you want to ensure that it is<br>
a US-based telephone number, you might also want to check that the phone number<br>
is 10 digits long.</p>
<p>Another example might be that you want to ensure that your users are creating<br>
strong and secure passwords. To do this, you could require and check for the<br>
presence of a symbol and a number in the password, or prevent users from setting<br>
&quot;password&quot; as their password.</p>
<h3 class="mume-header" id="other-validations">Other validations</h3>

<p>Validations do not have to be constrained to just checking one field at a time.<br>
To continue with the example on passwords, let&apos;s suppose you also wanted to add<br>
a &quot;Confirm Password&quot; field to ensure that users did not make a typo on their<br>
password when creating an account. In this scenario, it&apos;s necessary to add a<br>
validation to ensure that the &quot;Password&quot; and &quot;Confirmed Password&quot; fields have<br>
the same value.</p>
<p>Validations could get even more complex based on the needs of your application.<br>
For example, let&apos;s suppose you have a form for users to order products. You<br>
probably want to validate that their selected shipment order is valid given the<br>
order&apos;s weight and destination postal code. After all, you don&apos;t want users<br>
trying to select &quot;1-day delivery&quot; for a couch that needs to be transported<br>
across the country.</p>
<h2 class="mume-header" id="server-side-validations-an-example">Server-side validations: an example</h2>

<p>Let&apos;s pick up where last reading&apos;s example left off and add some server-side<br>
validations. As a reminder, in the last reading, you built a website that allows<br>
you to add guests to a guest list.</p>
<h3 class="mume-header" id="setup">Setup</h3>

<p>At this moment, the directory of that example should look like this:</p>
<pre data-role="codeBlock" data-info="plaintext" class="language-plaintext"><code>forms-demo
&#x2502;   node_modules/
|   views/
&#x2502;   &#x2502;   guest-form.pug
&#x2502;   &#x2502;   index.pug
&#x2502;   &#x2502;   layout.pug
&#x2502;   index.js
&#x2502;   package-lock.json
&#x2502;   package.json
</code></pre><p>The <code>index.js</code> file should look like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create the Express app.</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the pug view engine.</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pug&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> guests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Define a route.</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest List&quot;</span><span class="token punctuation">,</span> guests <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guest <span class="token operator">=</span> <span class="token punctuation">{</span>
    fullName<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>fullName<span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
    numGuests<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>numGuests
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  guests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a port and start listening for connections.</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8081</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The <code>views/layout.pug</code> template should look like this:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token doctype">doctype html</span>
<span class="token tag">html</span>
  <span class="token tag">head</span>
    <span class="token tag">title</span><span class="token punctuation">=</span><span class="token code"> title</span>
  <span class="token tag">body</span>
    <span class="token tag">h1</span><span class="token punctuation">=</span><span class="token code"> title</span>
    <span class="token tag">div</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;/&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Home</span>
    <span class="token tag">div</span>
      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Add Guest</span>

    <span class="token keyword">block content</span>


</pre><p>The <code>views/index.pug</code> file should look like this:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">table</span>
    <span class="token tag">thead</span>
      <span class="token tag">tr</span>
        <span class="token tag">th</span> <span class="token plain-text">Full Name</span>
        <span class="token tag">th</span> <span class="token plain-text">Email</span>
        <span class="token tag">th</span> <span class="token plain-text"># Guests</span>
    <span class="token tag">tbody</span>
      <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> guest <span class="token keyword">in</span></span> guests</span>
        <span class="token tag">tr</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.fullName}</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.email}</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.numGuests}</span>

</pre><p>Finally, the <code>guest-form.pug</code> should look like this:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">h2</span> <span class="token plain-text">Add Guest</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullName&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Full Name:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;text&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;fullName&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;fullName&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Num Guests</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;number&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;Add Guest&quot;</span></span><span class="token punctuation">)</span></span></span>

</pre><h3 class="mume-header" id="validations-checking-that-all-fields-are-filled">Validations: checking that all fields are filled</h3>

<p>First, because all three fields are important, let&apos;s add validations to ensure<br>
that each of the field is filled out with a value before it can be successfully<br>
submitted.</p>
<p>To be clear, you can add a <code>required</code> attribute to the three <code>input</code> fields, and<br>
the user would not be able to submit until each field has a value. However, as<br>
was discussed in the previous reading, these kinds of front-end validations can<br>
be circumvented, so for this reading, let&apos;s focus on how to implement these<br>
validations in the server.</p>
<p>To do this, instantiate an <code>errors</code> array in <code>app.post(&apos;/guest&apos;)</code>. Then, check<br>
for truthy values in each of the <code>req.body</code> fields, and if any of the fields are<br>
missing, then push in an error message into the <code>errors</code> array to notify the<br>
user about how that field is required:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fullName<span class="token punctuation">,</span> email<span class="token punctuation">,</span> numGuests <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fullName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the full name field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the email field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>numGuests<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the field for number of guests.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> guest <span class="token operator">=</span> <span class="token punctuation">{</span>
    fullName<span class="token punctuation">,</span>
    email<span class="token punctuation">,</span>
    numGuests
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  guests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now, if the <code>errors</code> array has an error message in it, then don&apos;t add the<br>
<code>guest</code> to the <code>guests</code> array. Instead, give the user an opportunity to fix the<br>
errors before resubmitting the form again.</p>
<p>You can do this by rendering the <code>guest-form.pug</code> template again along with the<br>
<code>errors</code> array. Then, update that template to display each error message to the<br>
user. Also, if there are errors, let&apos;s go ahead and return out of the callback<br>
function and ensure that none of the code below executes. Add this below the<br>
validations:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token comment">// VALIDATIONS HERE</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span><span class="token punctuation">,</span> errors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// `return` if there are errors.</span>
<span class="token punctuation">}</span>

<span class="token comment">// REST OF CODE NOT SHOWN</span>
</pre><p>Here&apos;s what that route should look like now:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fullName<span class="token punctuation">,</span> email<span class="token punctuation">,</span> numGuests <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fullName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the full name field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the email field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>numGuests<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the field for number of guests.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span><span class="token punctuation">,</span> errors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> guest <span class="token operator">=</span> <span class="token punctuation">{</span>
    fullName<span class="token punctuation">,</span>
    email<span class="token punctuation">,</span>
    numGuests
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  guests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Update <code>guest-form.pug</code> to display error messages whenever they exist:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">div</span>
    <span class="token tag">ul</span>
      <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> error <span class="token keyword">in</span></span> errors</span>
        <span class="token tag">li</span> <span class="token plain-text">#{error}</span>
  <span class="token tag">h2</span> <span class="token plain-text">Add Guest</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullName&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Full Name:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;text&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;fullName&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;fullName&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Num Guests</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;number&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;Add Guest&quot;</span></span><span class="token punctuation">)</span></span></span>


</pre><p>There&apos;s one more thing to fix here. One problem is that when the user navigates<br>
to <code>localhost:8081/guest</code> now, when <code>guest-form.pug</code> is rendered, the<br>
<code>app.get(&apos;/guest&apos;)</code> route is not rendering an <code>errors</code> variable. Therefore,<br>
when <code>guest-form.pug</code> tries to iterate through the <code>errors</code> array, there&apos;s an<br>
error because <code>errors</code> does not exist.</p>
<p>You have a couple of options here: you can either check for the truthiness of<br>
<code>errors</code> in <code>guest-form.pug</code>, or you can render an empty <code>errors</code> array variable<br>
in the <code>app.get(&apos;/guest&apos;)</code> route callback. For now, let&apos;s go ahead and go<br>
with the first option and update the <code>guest-form.pug</code> template:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token flow-control"><span class="token branch keyword">if</span> errors</span>
    <span class="token tag">div</span>
      <span class="token tag">ul</span>
        <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> error <span class="token keyword">in</span></span> errors</span>
          <span class="token tag">li</span> <span class="token plain-text">#{error}</span>
  <span class="token tag">h2</span> <span class="token plain-text">Add Guest</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullName&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Full Name:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;text&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;fullName&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;fullName&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Num Guests</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;number&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;Add Guest&quot;</span></span><span class="token punctuation">)</span></span></span>

</pre><p>Things should be working properly now! If the user forgets to submit any of the<br>
fields, the user should get a very specific message about which field needs to<br>
be filled out still.</p>
<h3 class="mume-header" id="validations-ensuring-that-numguests-is-valid">Validations: ensuring that <code>numGuests</code> is valid</h3>

<p>Let&apos;s add a couple more validations on the <code>numGuests</code> field to get really<br>
comfortable with data validations. First, it probably makes sense that the<br>
number of guests per entry on the guest list is at least one. Also, as<br>
previously mentioned, each of the values will arrive at the server as a string.<br>
Although, JavaScript automatically converts strings into numbers when a string<br>
is being compared to a number, it&apos;s good practice to compare values of the same<br>
type.</p>
<p>This brings up another necessary validation. Add a validation that checks to<br>
make sure that the <code>numGuests</code> field is actually a value that can be converted<br>
into a number. When you&apos;ve added these validations, your <code>app.post(&apos;/guest&apos;)</code><br>
route should look something like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fullName<span class="token punctuation">,</span> email<span class="token punctuation">,</span> numGuests <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> numGuestsNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>numGuests<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fullName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the full name field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the email field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>numGuests <span class="token operator">||</span> numGuests <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out a valid number for number of guests.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span><span class="token punctuation">,</span> errors <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> guest <span class="token operator">=</span> <span class="token punctuation">{</span>
    fullName<span class="token punctuation">,</span>
    email<span class="token punctuation">,</span>
    numGuests<span class="token punctuation">:</span> numGuestsNum
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  guests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>There are now validations in place to ensure that the <code>numGuests</code> field is a<br>
valid number that is greater than 0. Test to make sure this is working properly<br>
by changing the <code>numGuests</code> input type to &quot;text&quot; and submitting invalid data<br>
(you can either edit this directly in <code>guest-form.pug</code> or by opening up the<br>
developers console to edit the HTML)</p>
<h3 class="mume-header" id="improve-user-experience">Improve user experience</h3>

<p>One thing that&apos;s somewhat annoying right now is that any time there is a<br>
server-side error, all the fields get wiped, and the user has to fill them all<br>
out again. For example, even if the <code>fullName</code> and <code>email</code> fields were filled<br>
out without any issue, a small mistake on the <code>numGuests</code> field would require<br>
the user to have to start the whole process over again and fill out each field.</p>
<p>Let&apos;s improve the user experience by pre-setting each field with the values that<br>
they had just submitted. To do this, whenever there is an error, not only should<br>
you render the <code>errors</code> array, but also go ahead and render back the values from<br>
<code>req.body</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span><span class="token punctuation">,</span>
    errors<span class="token punctuation">,</span>
    email<span class="token punctuation">,</span>
    fullName<span class="token punctuation">,</span>
    numGuests
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre><p>Then, in <code>guest-form.pug</code>, set each input&apos;s <code>value</code> attribute to equal the<br>
associated variables that was rendered back:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token flow-control"><span class="token branch keyword">if</span> errors</span>
    <span class="token tag">div</span>
      <span class="token tag">ul</span>
        <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> error <span class="token keyword">in</span></span> errors</span>
          <span class="token tag">li</span> <span class="token plain-text">#{error}</span>
  <span class="token tag">h2</span> <span class="token plain-text">Add Guest</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullName&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Full Name:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;text&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;fullName&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;fullName&quot;</span> value<span class="token operator">=</span>fullName</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> value<span class="token operator">=</span>email</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Num Guests</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;number&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> value<span class="token operator">=</span>numGuests</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;Add Guest&quot;</span></span><span class="token punctuation">)</span></span></span>

</pre><p>Go ahead and test out the improved user experience! Now, each field&apos;s value<br>
should persist even if there was an error.</p>
<h2 class="mume-header" id="recap">Recap</h2>

<p>In this lesson, you learned:</p>
<ol>
<li>What data validation is and why it&apos;s necessary for the server to<br>
validate incoming data.</li>
<li>How to validate user-provided data from within an Express route handler<br>
function and return a response containing user-friendly validation error<br>
messages when necessary.</li>
</ol>
<hr>
<h1 class="mume-header" id="express-middleware">Express Middleware</h1>

<p>In a previous reading, we briefly introduced the urlencoded middleware function.<br>
Middleware functions are a critical part of a robust Express server. In this<br>
reading you will:</p>
<ol>
<li>Understand that the request pipeline in an Express application is composed of<br>
a series of middleware functions.</li>
<li>Write a custom middleware function that validates user-provided data<br>
(submitted via an HTML form), sets an array of user-friendly validation error<br>
messages on the Request object when necessary, and passes control to the next<br>
middleware function.</li>
</ol>
<h2 class="mume-header" id="middleware-overview">Middleware overview</h2>

<p>Express middleware is kind of a misnomer: because of the &quot;middle&quot; in<br>
&quot;middleware&quot;, you might assume that middleware is anything that sits between the<br>
client and the Express server. However, according to the<br>
<a href="https://expressjs.com/en/guide/using-middleware.html">Express documentation on using middleware</a>: &quot;An Express application is<br>
essentially a series of middleware function calls.&quot; Let&apos;s dive into what this<br>
means.</p>
<p>For starters, start up a demo server by running the following commands:</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash"><span class="token function">mkdir</span> middleware-demo
<span class="token function">cd</span> middleware-demo
<span class="token function">npm</span> init --yes
<span class="token function">npm</span> <span class="token function">install</span> express@^4.0.0
<span class="token function">npm</span> <span class="token function">install</span> nodemon@^2.0.0 --save-dev
<span class="token function">touch</span> index.js
</pre><p>Then, in your <code>index.js</code>, handle get requests to the root path by responding<br>
with &quot;Hello World!&quot;:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a port and start listening for connections.</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Set up a <code>start</code> script in your <code>package.json</code>:</p>
<pre data-role="codeBlock" data-info="json" class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;middleware-demo&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon index.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ISC&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;express&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.1&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;nodemon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Then start up your server by running <code>npm start</code></p>
<h3 class="mume-header" id="anatomy-of-a-middleware-function">Anatomy of a middleware function</h3>

<p>In Express, a middleware function is a function that takes three arguments, in<br>
this specific order:</p>
<ol>
<li><code>req</code>- the request object</li>
<li><code>res</code>- the response object</li>
<li><code>next</code>- according to the <a href="https://expressjs.com/en/guide/using-middleware.html">Express documentation on using middleware</a>: &quot;the<br>
next middleware function in the application&#x2019;s request-response cycle&quot;</li>
</ol>
<p>These arguments might seem a little familiar. Up to this point, you&apos;ve been<br>
handling all requests with a callback function that takes a <code>req</code> and <code>res</code><br>
argument.</p>
<p>For example, take a look at the callback function that you just set up to send<br>
back &quot;Hello World!&quot;: it takes <code>req</code> and <code>res</code> as the first two arguments. There<br>
is, in fact, an optional <code>next</code> argument that you could have passed into this<br>
function as well. The <code>next</code> argument will be discussed in more depth later in<br>
this reading.</p>
<p>This means that all of the callback functions that you&apos;ve been writing this<br>
whole time to handle requests and send back responses are actually middleware<br>
functions.</p>
<h3 class="mume-header" id="series-of-middleware-functions">Series of middleware functions</h3>

<p>As a reminder, the documentation mentioned that &quot;an Express application is a<br>
<em>series</em> of middleware function calls.&quot; To explore what &quot;series&quot; means there,<br>
let&apos;s set up another middleware function.</p>
<p>Here&apos;s the goal: let&apos;s set up a middleware function that logs the time of each<br>
request.</p>
<p>Remember, a middleware function takes three arguments: <code>req</code>, <code>res</code>, and <code>next</code>.<br>
In <code>index.js</code>, create a middleware function <code>logTime</code> that console logs the<br>
current time formatted as an ISO string. At the end of the middleware function,<br>
invoke the <code>next</code> function, which represents the next middleware function:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">logTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Current time: &quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Now, update the <code>app.get(&apos;/&apos;)</code> route so that it calls <code>logTime</code> before it<br>
invokes the anonymous callback function that sends back &quot;Hello World!&quot;:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> logTime<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>To confirm that this is working, refresh <code>localhost:3000</code> and check that your<br>
server logs are showing the current time of each request.</p>
<p>Let&apos;s recap what just happened:</p>
<ol>
<li>When the user lands on <code>localhost:3000</code>, a GET request is made to the &quot;/&quot; route of the Express server.</li>
<li>The first middleware function this route invokes is <code>logTime</code>. In <code>logTime</code>, the current time is logged. At the end of <code>logTime</code>, it invokes <code>next</code>, which represents the next middleware function.</li>
<li>The next middleware function in this example is the anonymous callback<br>
function that runs <code>res.send(&quot;Hello World!&quot;)</code>.</li>
</ol>
<p>You could invoke as many middleware functions as you&apos;d like. In addition,<br>
because the <code>req</code> and <code>res</code> objects are passed through every one of the<br>
middleware functions, you could store values in the <code>req</code> object for the next<br>
middleware function to use.</p>
<p>Let&apos;s explore this by creating another middleware function called <code>passOnMessage</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">passOnMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Passing on a message!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span>passedMessage <span class="token operator">=</span> <span class="token string">&quot;Hello from passOnMessage!&quot;</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Then, let&apos;s add this middleware function to the <code>app.get(&apos;/&apos;)</code> route and then<br>
console.log the <code>req.passedMessage</code> in one of the later middleware functions:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> logTime<span class="token punctuation">,</span> passOnMessage<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Passed Message: &quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>passedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><blockquote>
<p>In the example above, the <code>passedMessage</code> was added to the <code>req</code> object so<br>
that it could be used in a later middleware function. Alternatively, you might<br>
instead want to store properties inside of the <a href="https://expressjs.com/en/4x/api.html#res.locals">res.local</a> object so that you<br>
don&apos;t accidentally override an existing property in the <code>req</code> object.</p>
</blockquote>
<p>Instead of passing each middleware function in separate arguments, you could<br>
also pass them all in as one array argument:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>logTime<span class="token punctuation">,</span> passOnMessage<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Passed Message: &quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>passedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>The order does matter. Try changing up the order of the middleware functions and<br>
see the order of the console.log statements.</p>
<h3 class="mume-header" id="application-level-middleware">Application-level middleware</h3>

<p>To be clear, with the current set up, <code>logTime</code> and <code>passOnMessage</code> will only be<br>
executed for the <code>app.get(&apos;/&apos;)</code> route. For example, let&apos;s say you set up another<br>
route:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/bye&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Bye World.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Because that route does not currently take in <code>logTime</code> as one of its arguments,<br>
it would not invoke the <code>logTime</code> middleware function. To fix this, you could<br>
simply pass in the <code>logTime</code> function, but if there was a middleware function<br>
that you wanted to execute for every single route, this could be pretty tedious.</p>
<p>Setting up an application-level middleware function that runs for every single<br>
route is simple. In fact, the <code>express.urlencoded</code> middleware you set up in the<br>
previous reading was an application-level middleware.</p>
<p>To do this, remove <code>logTime</code> from the <code>app.get(&apos;/&apos;)</code> arguments. Instead, add it<br>
as an application-wide middleware by writing <code>app.use(logTime)</code>. After doing<br>
this, your <code>index.js</code> file should look like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">logTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Current time: &quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">passOnMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Passing on a message!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span>passedMessage <span class="token operator">=</span> <span class="token string">&quot;Hello from passOnMessage!&quot;</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> passOnMessage<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Passed Message: &quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>passedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/bye&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Bye World.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a port and start listening for connections.</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Now, whenever you navigate to either <code>localhost:3000</code> or <code>localhost:3000/bye</code>,<br>
the <code>passTime</code> middleware function will be executed. Note how the<br>
<code>passOnMessage</code> is only executed for the <code>app.get(&apos;/&apos;)</code> route.</p>
<h2 class="mume-header" id="data-validations-with-middleware">Data validations with middleware</h2>

<p>In the previous reading, you set up data validations in your Express server in<br>
the &quot;Guest List&quot; example.</p>
<p>Let&apos;s pick up where that example left off and move the data validations into a<br>
middleware function.</p>
<p>At this point, your <code>index.js</code> should look like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create the Express app.</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the pug view engine.</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pug&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> guests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Define a route.</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest List&quot;</span><span class="token punctuation">,</span> guests <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fullname<span class="token punctuation">,</span> email<span class="token punctuation">,</span> numGuests <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> numGuestsNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>numGuests<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fullname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the full name field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the email field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>numGuests <span class="token operator">||</span> numGuests <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out a valid number for number of guests.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span><span class="token punctuation">,</span>
      errors<span class="token punctuation">,</span>
      email<span class="token punctuation">,</span>
      fullname<span class="token punctuation">,</span>
      numGuests
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> guest <span class="token operator">=</span> <span class="token punctuation">{</span>
    fullname<span class="token punctuation">,</span>
    email<span class="token punctuation">,</span>
    numGuests<span class="token punctuation">:</span> numGuestsNum
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  guests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a port and start listening for connections.</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8081</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>You might be wondering why you would want to move the validation logic into a<br>
middleware function. Suppose you now wanted to add a route that would allow the<br>
user to update a <code>guest</code> on the guest list.</p>
<p>In that update route, you probably want to enforce the same validations. You<br>
could simply copy and paste over all of those validations, but having it in a<br>
middleware function would keep your code DRY.</p>
<p>To start, create a function called <code>validateGuest</code> and move all of the<br>
validation logic into that function.</p>
<p>Because this will be a middleware function, be sure to accept <code>req</code>, <code>res</code>, and<br>
<code>next</code> as arguments in the function.</p>
<p>Finally, your <code>validateGuest</code> functions should pass on error messages to a later<br>
function so the later function can render the error messages back to the client.</p>
<p>When you&apos;re done with your <code>validateGuest</code> function, it should look something<br>
like this:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">validateGuest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fullname<span class="token punctuation">,</span> email<span class="token punctuation">,</span> numGuests <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> numGuestsNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>numGuests<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fullname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the full name field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the email field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>numGuests <span class="token operator">||</span> numGuests <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out a valid number for number of guests.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  req<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors<span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre><p>Notice how the <code>errors</code> array is passed on to the next middleware function by<br>
being added to the <code>req</code> object. Update your <code>app.post(&apos;/guest&apos;)</code> route so that<br>
it now uses the <code>validateGuest</code> middleware function and so that it checks<br>
<code>req.errors</code> for error messages:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> validateGuest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fullname<span class="token punctuation">,</span> email<span class="token punctuation">,</span> numGuests <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span><span class="token punctuation">,</span>
      errors<span class="token punctuation">:</span> req<span class="token punctuation">.</span>errors<span class="token punctuation">,</span>
      email<span class="token punctuation">,</span>
      fullname<span class="token punctuation">,</span>
      numGuests
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> guest <span class="token operator">=</span> <span class="token punctuation">{</span>
    fullname<span class="token punctuation">,</span>
    email<span class="token punctuation">,</span>
    numGuests
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  guests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>In summary, moving validations into a middleware allows you to concisely reuse<br>
validations across different routes. In production-level projects, you&apos;ll likely<br>
use a validation library called <a href="https://express-validator.github.io/docs/">express-validator</a>, which follows the same<br>
pattern of validating data in middleware functions and then passing on error<br>
messages through the <code>req</code> object.</p>
<p>The <a href="https://express-validator.github.io/docs/">express-validator</a> library gives you a wide range of pre-built validations<br>
so that you don&apos;t have to implement validation logic from scratch. For example,<br>
it comes with a pre-built validation for checking whether an input field&apos;s is in<br>
a proper email format: <code>check(&apos;email&apos;).isEmail()</code>. You&apos;ll get a chance to<br>
explore the <code>express-validator</code> middleware functions more in today&apos;s project!</p>
<h2 class="mume-header" id="what-you-learned">What you learned</h2>

<p>In this reading, you learned:</p>
<ol>
<li>that the request pipeline in an Express application is composed of a series<br>
of middleware functions</li>
<li>how to write a custom middleware function that validates user-provided data<br>
(submitted via an HTML form), sets an array of user-friendly validation error<br>
messages on the Request object when necessary, and passes control to the next<br>
middleware function.</li>
</ol>
<hr>
<h1 class="mume-header" id="protecting-forms-from-csrf">Protecting forms from CSRF</h1>

<p>The web, unfortunately, is full of bad actors who consistently try to exploit<br>
any insecurities that a web application might have. This reading will talk about<br>
one common attack called Cross Site Request Forgery (CSRF).</p>
<p>In this reading, you will learn:</p>
<ol>
<li>How to use the <code>csurf</code> middleware to embed a token value in forms to protect<br>
against CSRF exploits.</li>
</ol>
<h2 class="mume-header" id="csrf-explained">CSRF explained</h2>

<p>Let&apos;s explain what CSRF is with an example. Imagine that you are a customer at a<br>
bank called &quot;Bad Bank Inc.&quot;. To put it bluntly, this bank sucks, and their<br>
website is full of security issues.</p>
<p>In any case, you decide one day that you need to send your brother some money,<br>
so you go <code>http://badbank.com</code> and sign into your account. Once you have<br>
provided the correct credentials to log in, <code>http://badbank.com</code> sends back a<br>
cookie.</p>
<blockquote>
<p><strong>Brief overview of cookies:</strong> At a super high level, when a user logs into a<br>
website, one way that the server can &quot;log in the user&quot; is by sending back a<br>
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">cookie</a> to the client. For example, if you log to <code>facebook.com</code>,<br>
<code>facebook.com</code>&apos;s server would send the browser back a cookie. Now, on every<br>
subsequent request to <code>facebook.com</code>, the browser would attach that cookie to<br>
the request. When the request arrives at the server, the server sees the<br>
cookie and sees that you&apos;re logged in and authorized to navigate around your<br>
account.</p>
</blockquote>
<p>Now that you&apos;re logged in, you navigate to <code>http://badbank.com/send-money</code>,<br>
which renders a a page that looks like this:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Bad Bank<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Send Money<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/send-money<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>recipient<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Recipient Email: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>recipient<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>recipient<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>amount<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Amount: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>amount<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>amount<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Send Money<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</pre><p>The page has a form where you can fill out a &quot;recipient&quot; field and an &quot;amount&quot;<br>
field. You fill out your brother&apos;s email <code>joe@gmail.com</code> in the recipient field<br>
and $100 for the amount, and then hit the &apos;Send Money&apos; button.</p>
<p>When you hit the &apos;Send Money&apos; button, the following happens:</p>
<ol>
<li>An HTTP POST request is made to <code>http://badbank.com/send-money</code>. When you<br>
logged in earlier, your browser received a cookie and stored it in<br>
association with <code>http://badbank.com</code>. Now, your browser sees this &quot;send<br>
money&quot; request going to the <code>http://badbank.com</code> domain, so it attaches that<br>
cookie to the HTTP request.</li>
<li>The request arrives at the server. The server sees that there is a cookie,<br>
and it checks the cookie.</li>
<li>Since the cookie is valid, the server knows that you are logged in, and the<br>
server processes the form data to see who you&apos;re sending money to and how<br>
much you are sending.</li>
<li>The server finishes processing the form data and sends $100 to your brother<br>
Joe.</li>
</ol>
<p>Things are going well so far!</p>
<p>Unfortunately, a devious hacker comes along. The hacker puts up another website<br>
that looks like this:</p>
<pre data-role="codeBlock" data-info="html" class="language-html"><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>See Cute Puppies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style language-css">
      <span class="token selector">form</span> <span class="token punctuation">{</span>
        <span class="token property">visibility</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token selector">input<span class="token attribute">[type=&quot;submit&quot;]</span></span> <span class="token punctuation">{</span>
        <span class="token property">visibility</span><span class="token punctuation">:</span> visible<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://badbank.com/send-money<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>recipient<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Recipient Email: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>recipient<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>recipient<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hacker@gmail.com<span class="token punctuation">&quot;</span></span>
      <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>amount<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Amount: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>number<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>amount<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>amount<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1000000<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>See the cutest puppies!<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</pre><p>Let&apos;s break down what&apos;s going on in the hacker&apos;s website:</p>
<ol>
<li>First, the hacker puts up the exact same &quot;Send Money&quot; form on his website: it<br>
hits the same endpoint (<code>http://badbank.com/send-money</code>) with the same method<br>
(&quot;post&quot;), and it has all the fields that the endpoint expects when parsing<br>
the form (&quot;recipient&quot; and &quot;amount&quot;).</li>
<li>One difference here is that the hacker hid the form on the website with CSS<br>
by setting the form&apos;s visibility to hidden.</li>
<li>The other key difference is that the hacker went ahead and pre-filled the<br>
recipient field&apos;s value to his own email address, <a href="mailto:%22hacker@gmail.com">&quot;hacker@gmail.com</a>&quot;, and<br>
then also pre-filled the &quot;amount&quot; field&apos;s value to 1 million.</li>
<li>The only part of the form that the hacker decides to show is the submit<br>
button, and he changed the button text to an irresistible prompt: &quot;See the<br>
cutest puppies!&quot;.</li>
<li>Naturally, you love puppies, so as you&apos;re browsing the web and land on this<br>
hacker&apos;s website, you click the button, thinking that you&apos;re about to see<br>
puppies.</li>
<li>Instead, a &quot;ost&quot; request gets sent to <code>http://badbank.com/send-money</code> along<br>
with the pre-filled form data.</li>
</ol>
<p>Here&apos;s the problem, because you had recently logged into <code>http://badbank.com</code>,<br>
your browser is currently storing the cookie to keep you logged in. When the<br>
browser sees that you are making another request to the <code>badbank.com</code> domain, it<br>
attaches the same cookie to the request that the hacker tricked you into making.</p>
<p>Now, when the hacker&apos;s request makes it to <code>badbank.com</code>&apos;s server, it sees the<br>
cookie, sees that you&apos;re logged in and thinks that it&apos;s you making the request,<br>
so it sends $1 million to <a href="mailto:%22hacker@gmail.com">&quot;hacker@gmail.com</a>&quot;.</p>
<h2 class="mume-header" id="preventing-csrf">Preventing CSRF</h2>

<p>One foundational strategy to prevent a CSRF attack would be to have your server<br>
render a secret token as part of the form. Then, when the form gets submitted,<br>
it checks for the secret token to verify that it actually came from a form that<br>
the server itself had rendered, and not from some other malicious source.</p>
<p>Now, when a hacker tries to imitate the form on his own website, his form<br>
wouldn&apos;t have the secret token, and the server would know to reject any requests<br>
from that malicious form.</p>
<p>Let&apos;s pick up where we left off in our previous reading&apos;s &quot;Guest List&quot; example<br>
and walk through how to implement this CSRF token strategy.</p>
<h3 class="mume-header" id="example-setup">Example setup</h3>

<p>At this point, here&apos;s what the <code>index.js</code> file for the &quot;Guest List&quot; example<br>
project should look like:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create the Express app.</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the pug view engine.</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pug&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> guests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Define a route.</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest List&quot;</span><span class="token punctuation">,</span> guests <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">validateGuest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fullname<span class="token punctuation">,</span> email<span class="token punctuation">,</span> numGuests <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> numGuestsNum <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>numGuests<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fullname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the full name field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out the email field.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>numGuests <span class="token operator">||</span> numGuests <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;Please fill out a valid number for number of guests.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  req<span class="token punctuation">.</span>errors <span class="token operator">=</span> errors<span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> validateGuest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fullname<span class="token punctuation">,</span> email<span class="token punctuation">,</span> numGuests <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span><span class="token punctuation">,</span>
      errors<span class="token punctuation">:</span> req<span class="token punctuation">.</span>errors<span class="token punctuation">,</span>
      email<span class="token punctuation">,</span>
      fullname<span class="token punctuation">,</span>
      numGuests
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> guest <span class="token operator">=</span> <span class="token punctuation">{</span>
    fullname<span class="token punctuation">,</span>
    email<span class="token punctuation">,</span>
    numGuests
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  guests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>guest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a port and start listening for connections.</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8081</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>Here&apos;s what the <code>index.pug</code> file looks like:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token tag">table</span>
    <span class="token tag">thead</span>
      <span class="token tag">tr</span>
        <span class="token tag">th</span> <span class="token plain-text">Full Name</span>
        <span class="token tag">th</span> <span class="token plain-text">Email</span>
        <span class="token tag">th</span> <span class="token plain-text"># Guests</span>
    <span class="token tag">tbody</span>
      <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> guest <span class="token keyword">in</span></span> guests</span>
        <span class="token tag">tr</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.fullname}</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.email}</span>
          <span class="token tag">td</span> <span class="token plain-text">#{guest.numGuests}</span>


<span class="token tag">Here</span>&apos;s what the `guest<span class="token punctuation">-</span>form<span class="token punctuation">.</span>pug` file looks like:

```pug
<span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token flow-control"><span class="token branch keyword">if</span> errors</span>
    <span class="token tag">div</span>
      <span class="token tag">ul</span>
        <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> error <span class="token keyword">in</span></span> errors</span>
          <span class="token tag">li</span> <span class="token plain-text">#{error}</span>
  <span class="token tag">h2</span> <span class="token plain-text">Add Guest</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullname&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Full Name:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullname&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;fullname&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;fullname&quot;</span> value<span class="token operator">=</span>fullname</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> value<span class="token operator">=</span>email</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Num Guests</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;number&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> value<span class="token operator">=</span>numGuests</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;Add Guest&quot;</span></span><span class="token punctuation">)</span></span></span>

</pre><h3 class="mume-header" id="using-the-csurf-library">Using the <code>csurf</code> library</h3>

<p>Let&apos;s use the <code>csurf</code> library to handle this whole process of creating a secret<br>
token for the form and then checking the secret token when forms are submitted.</p>
<p>The <code>csurf</code> library creates a middleware function that does the following:</p>
<ol>
<li>It creates a secret value, which is sent to the client and stored as a cookie<br>
named <code>_csrf</code>.</li>
<li>On every request for a form, a CSRF token is generated from that secret<br>
value. That CSRF token is then sent back to the client as part of the form in<br>
a hidden input field.</li>
<li>Whenever the client submits the form, the server checks the CSRF token that&apos;s<br>
embedded in the form and verifies that it is a valid CSRF token by checking<br>
it against the secret <code>_csrf</code> value that was attached to the request as a<br>
cookie.</li>
</ol>
<p>By taking the steps above, the hacker site would not have the CSRF token<br>
embedded as part of the form on his site, and therefore it would fail the CSRF<br>
token verification process.</p>
<p>Let&apos;s implement the above flow in the &quot;Guest List&quot; project. First, start by<br>
running <code>npm install csurf@^1.0.0</code>.</p>
<p>Then, go ahead and also install the <code>cookie-parser</code> middleware by running<br>
<code>npm install cookie-parser@^1.0.0</code>. Remember, the secret value is stored as a<br>
cookie named <code>_csrf</code>, so whenever the form is submitted, the server needs to be<br>
able to parse out the cookie in order to verify the CSRF token against the<br>
secret <code>_csrf</code> value.</p>
<p>At the top of <code>index.js</code>, require the <code>csurf</code> and <code>cookie-parser</code> dependencies.<br>
Add the <code>cookie-parser</code> middleware as an application-wide middleware function.<br>
For the <code>csurf</code> middleware, go ahead and create the function now so that you can<br>
later use it in specific routes:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;cookie-parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;csurf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create the Express app.</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the pug view engine.</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&quot;view engine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pug&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Adding cookieParser() as application-wide middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> csrfProtection <span class="token operator">=</span> <span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cookie<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// creating csrfProtection middleware to use in specific routes</span>

<span class="token comment">// REST OF FILE NOT SHOWN</span>
</pre><p>In the <code>app.get(&apos;/guest-form&apos;)</code> route, pass in the <code>csrfProtection</code> function as<br>
one of the middleware functions for that route. Then in the route&apos;s final<br>
callback middleware function, generate a CSRF token by calling<br>
<code>req.csrfToken()</code>.</p>
<p>The <code>csrfToken()</code> function was added to the <code>req</code> object by the <code>csrfProtection</code><br>
middleware. The middleware function also generated a secret <code>_csrf</code> value and<br>
stored it in the <code>res</code> object&apos;s headers so that the client can store it as a<br>
cookie. Finally, render the CSRF token under a <code>csrfToken</code> key so that the<br>
<code>guest-form.pug</code> template can use it:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;/guest-form&quot;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;guest-form&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">&quot;Guest Form&quot;</span><span class="token punctuation">,</span> csrfToken<span class="token punctuation">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre><p>In <code>guest-form.pug</code>, add a hidden input field with a <code>name</code> attribute of<br>
&quot;_csrf&quot; and the <code>value</code> attribute set to the <code>csrfToken</code> that the server<br>
renders:</p>
<pre data-role="codeBlock" data-info="pug" class="language-pug"><span class="token keyword">extends layout.pug</span>

<span class="token keyword">block content</span>
  <span class="token flow-control"><span class="token branch keyword">if</span> errors</span>
    <span class="token tag">div</span>
      <span class="token tag">ul</span>
        <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> error <span class="token keyword">in</span></span> errors</span>
          <span class="token tag">li</span> <span class="token plain-text">#{error}</span>
  <span class="token tag">h2</span> <span class="token plain-text">Add Guest</span>
  <span class="token tag">form<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">method</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;post&quot;</span> action<span class="token operator">=</span><span class="token string">&quot;/guest&quot;</span></span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;hidden&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;_csrf&quot;</span> value<span class="token operator">=</span>csrfToken</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullname&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Full Name:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;fullname&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;fullname&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;fullname&quot;</span> value<span class="token operator">=</span>fullname</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Email:</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;email&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;email&quot;</span> value<span class="token operator">=</span>email</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">label<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">for</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;numGuests&quot;</span></span><span class="token punctuation">)</span></span></span> <span class="token plain-text">Num Guests</span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;number&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;numGuests&quot;</span> value<span class="token operator">=</span>numGuests</span><span class="token punctuation">)</span></span></span>
    <span class="token tag">input<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">type</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;Add Guest&quot;</span></span><span class="token punctuation">)</span></span></span>

</pre><p>Finally, back in <code>index.js</code>, pass in the <code>csrfProtection</code> function to<br>
<code>app.post(&apos;/guest&apos;)</code>:</p>
<pre data-role="codeBlock" data-info="js" class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/guest&quot;</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> validateGuest<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// REST OF CODE NOT SHOWN</span>
<span class="token punctuation">}</span>
</pre><p>Now whenever the form is submitted, the <code>csrfProtection</code> middleware function<br>
verifies that the CSRF token that was set in the hidden input field is a valid<br>
token by checking it against the secret <code>_csrf</code> value that was sent as a cookie.</p>
<p>In summary, now, if a hacker tries to add a guest to your guest list, his form<br>
would be missing the CSRF token. Therefore, the endpoint throw an error and<br>
prevent a guest from being added.</p>
<p>There are <a href="https://github.com/pillarjs/understanding-csrf">other considerations</a> to take into account to fully protect your web<br>
applications from CSRF attacks. For now, adding the CSRF token is a solid first<br>
line of defense.</p>
<h2 class="mume-header" id="what-you-learned-1">What you learned</h2>

<p>In this reading, you learned how to use the csurf middleware to embed a token<br>
value in forms to protect against CSRF exploits.</p>
<p>This reading concludes this lesson on HTML Forms, and you&apos;re now ready to build<br>
out your own Express application that uses forms!</p>
<hr>
<h1 class="mume-header" id="formative-forms-project">Formative Forms Project</h1>

<p>Today you&apos;ll be going through the formative experience of building out an<br>
Express application that uses HTML forms!</p>
<p>This application allows users to create two types of user accounts: a normal<br>
user account and an interesting user account. It keeps track of all of the users<br>
in a table on the home page.</p>
<p>When you&apos;re done with the project, your web application should have the<br>
following features:</p>
<ol>
<li>Site-wide navigation elements that allows users to navigate between the home<br>
page and the two other pages.</li>
<li>A table that shows all of the existing users.</li>
<li>A form that can be used to create a normal user account.</li>
<li>A form that can be used to create an interesting user account.</li>
</ol>
<h2 class="mume-header" id="getting-started">Getting started</h2>

<ul>
<li>Clone the starter project from<br>
<a href="https://github.com/appacademy-starters/formative-forms-starter">https://github.com/appacademy-starters/formative-forms-starter</a></li>
<li>Run <code>npm install</code> to install the dependencies</li>
<li>Run <code>npm test</code> to run the tests for the project</li>
</ul>
<h2 class="mume-header" id="phase-0-intro-to-the-skeleton-directory">Phase 0: Intro to the skeleton directory</h2>

<p>The skeleton directory has a bare bone <code>index.js</code> file that renders &quot;Hello<br>
World!&quot; when a user land on <code>localhost:3000/</code>. There&apos;s also a <code>users</code> array that<br>
already has one user created for you. Throughout the project, as you add new<br>
users, you&apos;ll do so by pushing the new users into this array.</p>
<p>It also has a <code>layout.pug</code> template that your other templates can extend. The<br>
<code>layout.pug</code> imports Bootstrap stylesheets in the <code>head</code> element. Feel free to<br>
make your website look fancy with the available Bootstrap styling by adding<br>
Bootstrap class names to your elements.</p>
<p>For example, here is the documentation on how to<br>
<a href="https://getbootstrap.com/docs/4.4/components/forms/">add Bootstrap styles to a form element</a> by adding the Bootstrap classes to each<br>
element.</p>
<h2 class="mume-header" id="phase-1-home-page">Phase 1: Home page</h2>

<p>Pass each of the specs in <code>01_home.test.js</code> file. Running <code>npm test</code> will run<br>
every single test across all five test files. If you only want to run the specs<br>
in <code>01_home.test.js</code>, run <code>npm test -- --grep home</code>. The <code>--grep</code> flag only<br>
executes tests with names that match the passed in option value.</p>
<p>Overall, this project will give you ample opportunity to get familiar with<br>
reading specs and then building out features to satisfy those specs. Be sure to<br>
check the specs often for guidance!</p>
<p>In this first phase, create an <code>index.pug</code> template and update the <code>app.get(&quot;/&quot;)</code><br>
route so that it renders the index template. Remember to render the <code>users</code><br>
array so that it&apos;s available in the <code>index.pug</code> template.</p>
<p><a href="https://pugjs.org/language/inheritance.html">Extend</a> the <code>index.pug</code> template to inherit from <code>layout.pug</code>. Declare a block<br>
named &quot;content&quot; and add a table to render existing users. Follow the specs to<br>
create an <code>h2</code> header for the table.</p>
<blockquote>
<p><strong>Hint:</strong> Read the error messages to see the expected header name.</p>
</blockquote>
<p>Create table headers and columns for each user&apos;s information.</p>
<blockquote>
<p><strong>Hint:</strong> Take a look at 01_home.test.js to view what columns are expected in<br>
the table.</p>
</blockquote>
<p>At the top of the <code>body</code> element in <code>layout.pug</code>, add navigation links so that<br>
users can easily navigate between the home page (&quot;/&quot; route), normal user<br>
creation form (&quot;/create&quot; route), and interesting user creation form<br>
(&quot;/create-interesting&quot; route).</p>
<h2 class="mume-header" id="phase-2-create-the-normal-user-form">Phase 2: Create the normal user form</h2>

<p>Pass each of the specs in <code>02_create_form.test.js</code>. You can run the specs in<br>
this file by running <code>npm test -- --grep create-normal</code>.</p>
<p>In this phase, go ahead and set up this route to use the <a href="https://www.npmjs.com/package/csurf">csurf</a> middleware to<br>
render a CSRF token in a hidden input field. Be sure to in the <code>{cookie: true}</code><br>
options when creating the middleware function.</p>
<p>Because your application will be using cookies to store the secret CSRF value,<br>
go ahead and also set up the <a href="https://www.npmjs.com/package/cookie-parser">cookie-parser</a> middleware as an application-wide<br>
middleware function.</p>
<p>Set up a route so that when users land on <code>/create</code>, a form renders with the<br>
following fields:</p>
<ul>
<li><code>_csrf</code> <strong>(hidden field)</strong></li>
<li><code>firstName</code></li>
<li><code>lastName</code></li>
<li><code>email</code></li>
<li><code>password</code></li>
<li><code>confirmedPassword</code></li>
</ul>
<p>Be sure to set correct input <code>type</code> and <code>name</code> attributes, and also remember to<br>
<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/label">add a label</a> correlating to each input field&apos;s <code>name</code>.</p>
<p>Make sure your <code>_csrf</code> field has an appropriate value from your middleware. At<br>
this point, remove some duplication from your Pug template by leveraging<br>
<a href="https://pugjs.org/language/mixins.html">mixins</a>. Create a mixin to easily generate <code>label</code> and <code>input</code> element pairs.<br>
Think of how you would create a mixin using <code>input</code> attributes as parameters.</p>
<h2 class="mume-header" id="phase-3-submitting-the-form">Phase 3: Submitting the form</h2>

<p>Pass each of the specs in <code>03_form_submit.test.js</code>. You can run the specs in<br>
this file by running <code>npm test -- --grep form-submit</code>.</p>
<p>Begin by setting up a <code>&quot;/create&quot;</code> route to handle POST requests. Now that you<br>
are handling POST requests, you&apos;ll need access to <code>req.body</code>. Have your<br>
application use the <code>express.urlencoded</code> middleware to decode the form&apos;s request<br>
body string into data that can be accessible in <code>req.body</code>.</p>
<p>The next step is to protect this route from CSRF attacks by using the middleware<br>
function that you set up using the <a href="https://www.npmjs.com/package/csurf">csurf</a> library. Make sure you&apos;ve included<br>
the middleware function in both of the GET and POST <code>&quot;/create&quot;</code> routes.</p>
<p>Now set up data validations and create an <code>errors</code> array within the<br>
<code>app.post(&quot;/create&quot;)</code> route. You want to validate whether the user has provided<br>
a <code>firstName</code>, <code>lastName</code>, <code>email</code>, and <code>password</code>. Read the error messages from<br>
the specs to determine what messages to <code>push</code> into your <code>errors</code> array.</p>
<p>Time to update the <code>create.pug</code> template to render the error messages. Start by<br>
creating an unordered list at the top of your <code>create-form.pug</code> block. Inside of<br>
the unordered list, add a paragraph element with the following content:<br>
<code>The following errors were found:</code>. Now, iterate through each error to create<br>
list items with the error messages. Only render errors if they are present in<br>
the <code>errors</code> array. How can you determine if there are errors present?</p>
<p>You&apos;ll want to be sure that you&apos;re pre-filling each input field with<br>
already-submitted values so that users don&apos;t have to fill out all of the fields<br>
again whenever there are errors. How can you update your <code>input</code> elements so<br>
that already-submitted values are still showing even after a form submission<br>
fails a data validation?</p>
<h2 class="mume-header" id="phase-4-create-interesting-user-form">Phase 4: Create interesting user form</h2>

<p>Pass each of the specs in <code>04_create_interesting_form.test.js</code>. You can run the<br>
specs in this file by running <code>npm test -- --grep create-interesting</code>.</p>
<p>Notice how this form includes all of the fields from the first form. Reduce code<br>
duplication by leveraging the Pug <a href="https://pugjs.org/language/includes.html">includes</a> feature.</p>
<p>One way you could refactor is to create an <code>includes</code> directory inside your<br>
views and make the following files:</p>
<ul>
<li><code>views/includes/errors.pug</code></li>
<li><code>views/includes/form-inputs.pug</code></li>
</ul>
<p>Now create a <code>create-interesting.pug</code> template for your &quot;interesting user form&quot;<br>
and refactor your <code>create.pug</code> template to leverage the Pug <code>includes</code> feature.<br>
Start by dividing your existing <code>create.pug</code> template into <code>errors.pug</code> and<br>
<code>form-inputs.pug</code>. Think of how to use the templates to keep your code DRY.</p>
<h2 class="mume-header" id="phase-5-submit-create-interesting-user-form">Phase 5: Submit create interesting user form</h2>

<p>Pass each of the specs in <code>05_interesting_form_submit.test.js</code>. You can run the<br>
specs in this file by running <code>npm test -- --grep submit-interesting</code>.</p>
<p>Go ahead and add validations and write error messages for this new form. Because<br>
this new form still has the same base fields as the other form, be sure to still<br>
run the same validations that you are currently running for the<br>
<code>app.post(&apos;/create&apos;)</code> route. If you have not done so already, go ahead and move<br>
all of the validations for the first form into a custom middleware function that<br>
both <code>app.post(&apos;/create&apos;)</code> and <code>app.post(&apos;/create-interesting</code>) can use. Be sure<br>
to store those errors on the <code>req</code> object so that they can be used in a later<br>
middleware function.</p>
<p>Once you&apos;ve ensured that your base fields are being validated, go ahead and add<br>
validations for the new <code>age</code> and <code>favoriteBeatle</code> fields. Follow the error<br>
messages in the specs to determine what your error messages should be. Please<br>
write these new validations in a custom middleware function.</p>
<p>Create <a href="https://pugjs.org/language/mixins.html">mixins</a> for the <code>favoriteBeatle</code> options. How can you make sure that a<br>
user&apos;s <code>favoriteBeatle</code> is automatically selected when a form with errors<br>
re-renders upon submission?</p>
<p>How can you make sure a user&apos;s <code>iceCream</code> checkbox accurately renders whether<br>
the user likes ice cream upon an unsuccessful form submission? When saving the<br>
user, be sure to use the checkbox&apos;s value (ex: &quot;on&quot;) to convert the<br>
<code>user.iceCream</code> property to a boolean.</p>
<p>Finally, make sure your <code>index.pug</code> template is also rendering your new user<br>
properties.</p>
<p>You&apos;ve made it! Confirm that your whole app works as expected by running<br>
<code>npm test</code>.</p>
<h2 class="mume-header" id="bonus">Bonus</h2>

<p>In a production-level Express application, you&apos;ll likely use a library to help<br>
handle most of your data validation. One of the most popular data validation<br>
libraries is the <a href="https://express-validator.github.io/docs/">express-validator</a> library, which gives you a wide range of<br>
robust validations right out of the box.</p>
<p>Install this dependency and use it to add a validation to check that the user<br>
password being submitted is at least 5 characters long and that it at least has<br>
one number in it.</p>
<p>Then, go ahead and migrate any validations that you had on the <code>age</code> and<br>
<code>favoriteBeatle</code> fields to use the <a href="https://express-validator.github.io/docs/">express-validator</a> library instead.</p>
<p>Once you&apos;re done with those fields, continue migrating all other validations to<br>
use <a href="https://express-validator.github.io/docs/">express-validator</a> and add validations to check <em>all</em> user input (e.g,<br>
checking that a valid email is submitted).</p>

      </div>
      <div class="md-sidebar-toc"><ul>
<li><a href="#html-forms-learning-objectives">HTML Forms Learning Objectives</a></li>
<li><a href="#html-forms-an-introduction">HTML Forms: An Introduction</a>
<ul>
<li><a href="#key-components-of-a-form">Key components of a form</a>
<ul>
<li><a href="#form"><code>&lt;form&gt;</code></a></li>
<li><a href="#input"><code>&lt;input&gt;</code></a></li>
</ul>
</li>
<li><a href="#submitting-the-form">Submitting the form</a></li>
<li><a href="#what-youve-learned">What you&apos;ve learned</a></li>
</ul>
</li>
<li><a href="#html-forms-in-express">HTML Forms in Express</a>
<ul>
<li><a href="#forms-example-setup">Forms example setup</a></li>
<li><a href="#getting-the-add-guest-form">Getting the &quot;Add Guest&quot; form</a></li>
<li><a href="#a-quick-aside-pug-layout-templates">A quick aside: Pug layout templates</a></li>
<li><a href="#submitting-the-guest-form">Submitting the guest form</a>
<ul>
<li><a href="#x-www-form-urlencoded"><code>x-www-form-urlencoded</code></a></li>
<li><a href="#parsing-the-request-body">Parsing the request body</a></li>
</ul>
</li>
<li><a href="#what-youve-learned-1">What you&apos;ve learned</a></li>
</ul>
</li>
<li><a href="#data-validation">Data Validation</a>
<ul>
<li><a href="#importance-of-server-side-data-validation">Importance of server-side data validation</a>
<ul>
<li><a href="#lack-of-trust-in-client-side-validations">Lack of trust in client-side validations</a></li>
</ul>
</li>
<li><a href="#server-side-validations">Server-side validations</a>
<ul>
<li><a href="#expected-data-types">Expected data types</a></li>
<li><a href="#valid-ranges-and-format">Valid ranges and format</a></li>
<li><a href="#other-validations">Other validations</a></li>
</ul>
</li>
<li><a href="#server-side-validations-an-example">Server-side validations: an example</a>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#validations-checking-that-all-fields-are-filled">Validations: checking that all fields are filled</a></li>
<li><a href="#validations-ensuring-that-numguests-is-valid">Validations: ensuring that <code>numGuests</code> is valid</a></li>
<li><a href="#improve-user-experience">Improve user experience</a></li>
</ul>
</li>
<li><a href="#recap">Recap</a></li>
</ul>
</li>
<li><a href="#express-middleware">Express Middleware</a>
<ul>
<li><a href="#middleware-overview">Middleware overview</a>
<ul>
<li><a href="#anatomy-of-a-middleware-function">Anatomy of a middleware function</a></li>
<li><a href="#series-of-middleware-functions">Series of middleware functions</a></li>
<li><a href="#application-level-middleware">Application-level middleware</a></li>
</ul>
</li>
<li><a href="#data-validations-with-middleware">Data validations with middleware</a></li>
<li><a href="#what-you-learned">What you learned</a></li>
</ul>
</li>
<li><a href="#protecting-forms-from-csrf">Protecting forms from CSRF</a>
<ul>
<li><a href="#csrf-explained">CSRF explained</a></li>
<li><a href="#preventing-csrf">Preventing CSRF</a>
<ul>
<li><a href="#example-setup">Example setup</a></li>
<li><a href="#using-the-csurf-library">Using the <code>csurf</code> library</a></li>
</ul>
</li>
<li><a href="#what-you-learned-1">What you learned</a></li>
</ul>
</li>
<li><a href="#formative-forms-project">Formative Forms Project</a>
<ul>
<li><a href="#getting-started">Getting started</a></li>
<li><a href="#phase-0-intro-to-the-skeleton-directory">Phase 0: Intro to the skeleton directory</a></li>
<li><a href="#phase-1-home-page">Phase 1: Home page</a></li>
<li><a href="#phase-2-create-the-normal-user-form">Phase 2: Create the normal user form</a></li>
<li><a href="#phase-3-submitting-the-form">Phase 3: Submitting the form</a></li>
<li><a href="#phase-4-create-interesting-user-form">Phase 4: Create interesting user form</a></li>
<li><a href="#phase-5-submit-create-interesting-user-form">Phase 5: Submit create interesting user form</a></li>
<li><a href="#bonus">Bonus</a></li>
</ul>
</li>
</ul>
</div>
      <a id="sidebar-toc-btn">&#x2261;</a>
    
    
    
    
    
    
    
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  
    </body></html>