  <!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
  <html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog-Post</title>
    <!--------------------------------(syntax hilighting)------------------------------------->
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.4.0/build/styles/default.min.css" />
    <link rel="stlyesheet" href="./prism.css">
    <!-------------------------------------(scripts)------------------------------------------>
<<<<<<< HEAD
    <script async defer src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.4.0/build/highlight.min.js"></script>
=======
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.4.0/build/highlight.min.js"></script>
>>>>>>> faa6aaf237eae4895460e74eebaa130feb27079a
    <script async src="./prism.js"></script>


    <link rel="stylesheet" href="./css/bootstrap.css">
    <link rel="stylesheet" href="./css/bootstrap.grid.css">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/bootstrap-reboot.min.css">
    <link rel="stylesheet" href="./css/bootstrap.css.map">
    <link rel="stylesheet" href="./css/blog-home.css">
    <link rel="stylesheet" href="./css/prism.css">
    <script async defer src="./css/prism.js"></script>
  </head>
<!--------------------------------------------------------------------------------------------------->
<!--------------------------------------------------------------------------------------------------->
<!--------------------------------------------------------------------------------------------------->
<!--------------------------------------------------------------------------------------------------->
<!--------------------------------------------------------------------------------------------------->



  <body> 

<<<<<<< HEAD
<a class ="btn" href="https://5fe258337e0d0d0007bcdc71--focused-pasteur-0faac8.netlify.app/">HOME</a>
=======
<a class ="btn" href="https://focused-pasteur-0faac8.netlify.app/">HOME</a>
>>>>>>> faa6aaf237eae4895460e74eebaa130feb27079a







    <p>I was using <a href="http://mongoosejs.com/">mongoosejs</a> for connecting mongoDB from my NodeJS app. When an
      action involve mulitple queries it tend to be callback hell.</p>
    <p>I didnâ€™t used <code>populate</code> method for loading related data to demonstate the promises.</p>
    <p>I start with connecting mongoose with the mongoDB.</p>
    <div class="sourceCode" id="cb1">
      <pre
        class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="co">// connection.js</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">var</span> mongoose <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;mongoose&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="va">mongoose</span>.<span class="at">connect</span>(<span class="st">&quot;mongodb://localhost/my_db&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">var</span> db <span class="op">=</span> <span class="va">mongoose</span>.<span class="at">connection</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="va">db</span>.<span class="at">on</span>(<span class="st">&quot;error&quot;</span><span class="op">,</span> <span class="va">console</span>.<span class="va">error</span>.<span class="at">bind</span>(console<span class="op">,</span> <span class="st">&quot;Connection Error : &quot;</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="va">db</span>.<span class="at">once</span>(<span class="st">&quot;open&quot;</span><span class="op">,</span> <span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb1-9" title="9">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Connection ok!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-11" title="11"></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> mongoose<span class="op">;</span></a></code></pre>
    </div>
    <p>And mongoose models looks like</p>
    <div class="sourceCode" id="cb2">
      <pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="co">// User model</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">// models/user.js</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">var</span> mongoose <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../connection&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">var</span> Schema <span class="op">=</span> <span class="va">mongoose</span>.<span class="at">Schema</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">var</span> ObjectId <span class="op">=</span> <span class="va">Schema</span>.<span class="at">ObjectId</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw">var</span> UserSchema <span class="op">=</span> <span class="kw">new</span> <span class="at">Schema</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" title="8">  <span class="dt">email</span><span class="op">:</span> String<span class="op">,</span></a>
<a class="sourceLine" id="cb2-9" title="9">  <span class="dt">access_token</span><span class="op">:</span> String<span class="op">,</span></a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="dt">name</span><span class="op">:</span> String<span class="op">,</span></a>
<a class="sourceLine" id="cb2-11" title="11">  <span class="dt">username</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="dt">type</span><span class="op">:</span> String<span class="op">,</span></a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="dt">required</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-14" title="14">    <span class="dt">index</span><span class="op">:</span> <span class="op">{</span> <span class="dt">unique</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">sparse</span><span class="op">:</span> <span class="kw">true</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb2-15" title="15">  <span class="op">},</span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-17" title="17"></a>
<a class="sourceLine" id="cb2-18" title="18"><span class="co">//Project model</span></a>
<a class="sourceLine" id="cb2-19" title="19"><span class="co">// models/project.js</span></a>
<a class="sourceLine" id="cb2-20" title="20"><span class="kw">var</span> mongoose <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../connection&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-21" title="21"><span class="kw">var</span> Schema <span class="op">=</span> <span class="va">mongoose</span>.<span class="at">Schema</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-22" title="22"><span class="kw">var</span> ObjectId <span class="op">=</span> <span class="va">Schema</span>.<span class="at">ObjectId</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-23" title="23"></a>
<a class="sourceLine" id="cb2-24" title="24"><span class="kw">var</span> ProjectSchema <span class="op">=</span> <span class="kw">new</span> <span class="at">Schema</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb2-25" title="25">  <span class="dt">name</span><span class="op">:</span> String<span class="op">,</span></a>
<a class="sourceLine" id="cb2-26" title="26">  <span class="dt">user_id</span><span class="op">:</span> <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> ObjectId<span class="op">,</span> <span class="dt">ref</span><span class="op">:</span> <span class="st">&quot;User&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb2-27" title="27"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-28" title="28"></a>
<a class="sourceLine" id="cb2-29" title="29"><span class="co">//Issue model</span></a>
<a class="sourceLine" id="cb2-30" title="30"><span class="co">// models/issue.js</span></a>
<a class="sourceLine" id="cb2-31" title="31"><span class="kw">var</span> mongoose <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;../connection&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb2-32" title="32"><span class="kw">var</span> Schema <span class="op">=</span> <span class="va">mongoose</span>.<span class="at">Schema</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-33" title="33"><span class="kw">var</span> ObjectId <span class="op">=</span> <span class="va">Schema</span>.<span class="at">ObjectId</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-34" title="34"></a>
<a class="sourceLine" id="cb2-35" title="35"><span class="kw">var</span> IssueSchema <span class="op">=</span> <span class="kw">new</span> <span class="at">Schema</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb2-36" title="36">  <span class="dt">title</span><span class="op">:</span> String<span class="op">,</span></a>
<a class="sourceLine" id="cb2-37" title="37">  <span class="dt">body</span><span class="op">:</span> String<span class="op">,</span></a>
<a class="sourceLine" id="cb2-38" title="38">  <span class="dt">project_id</span><span class="op">:</span> <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> ObjectId<span class="op">,</span> <span class="dt">ref</span><span class="op">:</span> <span class="st">&quot;Project&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb2-39" title="39"><span class="op">}</span>)<span class="op">;</span></a></code></pre>
    </div>
    <p>So when I need to list all the issues of a project I need to fetch the User then the Project and the list issues
      of that project. Let the route for the action like <code>/:username/:project/issues</code>. So Initially my action
      code looks like,</p>
    <div class="sourceCode" id="cb3">
      <pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">var</span> User <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models/user&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">var</span> Project <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models/project&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">var</span> Issue <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models/issue&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="va">exports</span>.<span class="at">index</span> <span class="op">=</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-6" title="6">  <span class="kw">var</span> username <span class="op">=</span> <span class="va">req</span>.<span class="va">params</span>.<span class="at">username</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-7" title="7">  <span class="kw">var</span> project <span class="op">=</span> <span class="va">req</span>.<span class="va">params</span>.<span class="at">project</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-8" title="8"></a>
<a class="sourceLine" id="cb3-9" title="9">  <span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">username</span><span class="op">:</span> username <span class="op">},</span> <span class="kw">function</span> (err<span class="op">,</span> user) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-11" title="11">      <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-12" title="12">      <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-13" title="13">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-14" title="14">    <span class="va">Project</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">name</span><span class="op">:</span> project<span class="op">,</span> <span class="dt">user</span><span class="op">:</span> <span class="va">user</span>.<span class="at">_id</span> <span class="op">},</span> <span class="kw">function</span> (err<span class="op">,</span> project) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-15" title="15">      <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-16" title="16">        <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-17" title="17">        <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-18" title="18">      <span class="op">}</span></a>
<a class="sourceLine" id="cb3-19" title="19"></a>
<a class="sourceLine" id="cb3-20" title="20">      <span class="va">Issues</span>.<span class="at">find</span>(<span class="op">{</span> <span class="dt">project_id</span><span class="op">:</span> <span class="va">project</span>.<span class="at">_id</span> <span class="op">},</span> <span class="kw">function</span> (err<span class="op">,</span> issues) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-21" title="21">        <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-22" title="22">          <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-23" title="23">          <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-24" title="24">        <span class="op">}</span></a>
<a class="sourceLine" id="cb3-25" title="25"></a>
<a class="sourceLine" id="cb3-26" title="26">        <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;./views/issues/index&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-27" title="27">          <span class="dt">user</span><span class="op">:</span> user<span class="op">,</span></a>
<a class="sourceLine" id="cb3-28" title="28">          <span class="dt">project</span><span class="op">:</span> poject<span class="op">,</span></a>
<a class="sourceLine" id="cb3-29" title="29">          <span class="dt">issues</span><span class="op">:</span> issues<span class="op">,</span></a>
<a class="sourceLine" id="cb3-30" title="30">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-31" title="31">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-32" title="32">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-33" title="33">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-34" title="34"><span class="op">};</span></a></code></pre>
    </div>
    <p>But this code looks difficult to maintain for me. I usually uses promises to avoid callback hell. So I thought of
      using promises with mongoosejs since they have inbuilt support for it. So I rewrote my code with promises</p>
    <div class="sourceCode" id="cb4">
      <pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">var</span> User <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models/user&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">var</span> Project <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models/project&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">var</span> Issue <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models/issue&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="va">exports</span>.<span class="at">index</span> <span class="op">=</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">  <span class="kw">var</span> username <span class="op">=</span> <span class="va">req</span>.<span class="va">params</span>.<span class="at">username</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="kw">var</span> project <span class="op">=</span> <span class="va">req</span>.<span class="va">params</span>.<span class="at">project</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-8" title="8"></a>
<a class="sourceLine" id="cb4-9" title="9">  <span class="va">User</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">username</span><span class="op">:</span> username <span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-10" title="10">    .<span class="at">exec</span>()</a>
<a class="sourceLine" id="cb4-11" title="11">    .<span class="at">then</span>(<span class="kw">function</span> (user) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-12" title="12">      <span class="kw">var</span> result <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb4-13" title="13">      <span class="cf">return</span> <span class="va">Project</span>.<span class="at">findOne</span>(<span class="op">{</span> <span class="dt">name</span><span class="op">:</span> project<span class="op">,</span> <span class="dt">user_id</span><span class="op">:</span> <span class="va">user</span>.<span class="at">_id</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-14" title="14">        .<span class="at">exec</span>()</a>
<a class="sourceLine" id="cb4-15" title="15">        .<span class="at">then</span>(<span class="kw">function</span> (project) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-16" title="16">          <span class="cf">return</span> [user<span class="op">,</span> project]<span class="op">;</span></a>
<a class="sourceLine" id="cb4-17" title="17">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-18" title="18">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-19" title="19">    .<span class="at">then</span>(<span class="kw">function</span> (result) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-20" title="20">      <span class="kw">var</span> project <span class="op">=</span> result[<span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb4-21" title="21">      <span class="cf">return</span> <span class="va">Issues</span>.<span class="at">find</span>(<span class="op">{</span> <span class="dt">project_id</span><span class="op">:</span> <span class="va">project</span>.<span class="at">_id</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-22" title="22">        .<span class="at">exec</span>()</a>
<a class="sourceLine" id="cb4-23" title="23">        .<span class="at">then</span>(<span class="kw">function</span> (issues) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-24" title="24">          <span class="va">result</span>.<span class="at">push</span>(issues)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-25" title="25">          <span class="cf">return</span> result<span class="op">;</span></a>
<a class="sourceLine" id="cb4-26" title="26">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-27" title="27">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-28" title="28">    .<span class="at">then</span>(<span class="kw">function</span> (result) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-29" title="29">      <span class="kw">var</span> user <span class="op">=</span> result[<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb4-30" title="30">      <span class="kw">var</span> project <span class="op">=</span> result[<span class="dv">1</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb4-31" title="31">      <span class="kw">var</span> issues <span class="op">=</span> result[<span class="dv">2</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb4-32" title="32"></a>
<a class="sourceLine" id="cb4-33" title="33">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&quot;./views/issues/index&quot;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-34" title="34">        <span class="dt">user</span><span class="op">:</span> user<span class="op">,</span></a>
<a class="sourceLine" id="cb4-35" title="35">        <span class="dt">project</span><span class="op">:</span> project<span class="op">,</span></a>
<a class="sourceLine" id="cb4-36" title="36">        <span class="dt">issues</span><span class="op">:</span> issues<span class="op">,</span></a>
<a class="sourceLine" id="cb4-37" title="37">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-38" title="38">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-39" title="39">    .<span class="at">then</span>(<span class="kw">undefined</span><span class="op">,</span> <span class="kw">function</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-40" title="40">      <span class="co">//Handle error</span></a>
<a class="sourceLine" id="cb4-41" title="41">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-42" title="42"><span class="op">};</span></a></code></pre>
    </div>
    <p>Have you noticed the use of <code>exec()</code> method? In mongoose, <a
        href="http://mongoosejs.com/docs/api.html#query_Query-exec">exec</a> method will execute the query and return a
      <strong>Promise</strong>. We can make this code even better using <code>populate</code> method, Since I am
      learning this is far better than before and let the <code>populate</code> method be subject for another blog post.
      ;)
    </p>
    <p>Comments are welcome.</p>

  </body>

  
</html>
